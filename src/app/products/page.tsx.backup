'use client';

import { useState, useEffect, useCallback, useMemo } from 'react';
import Layout from '@/components/Layout';
import { Package, Trash2, X, ExternalLink, Copy, Check, Image, Loader2, Eye, Camera, RotateCcw, Warehouse, Download, Crop, List, Type, AlertCircle, RefreshCw, Search, Filter, Settings, BarChart3, TrendingUp, Activity } from 'lucide-react';
import * as XLSX from 'xlsx';
import { 
  useProducts, 
  useProductModal, 
  ProductTable, 
  Product
} from '@/modules/products';
import { AnymarketSyncModal } from '@/components/AnymarketSyncModal';
import { CropImagesModal } from '@/components/CropImagesModal';
import { SimpleSkusModal } from '@/components/SimpleSkusModal';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Combobox } from '@/components/ui/combobox';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Input } from '@/components/ui/input';
import { Skeleton } from '@/components/ui/skeleton';
import { Progress } from '@/components/ui/progress';

// Fun√ß√£o auxiliar para formatar data
const formatDate = (dateString: string | null | undefined): string => {
  if (!dateString) return 'Data n√£o dispon√≠vel';
  
  try {
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return 'Data inv√°lida';
    return date.toLocaleString('pt-BR');
  } catch (error) {
    return 'Data inv√°lida';
  }
};

export default function ProductsPage() {
  // Estados locais
  const [selectedProducts, setSelectedProducts] = useState<number[]>([]);
  const [showImageAnalysisModal, setShowImageAnalysisModal] = useState(false);
  const [showAnalysisSelectionModal, setShowAnalysisSelectionModal] = useState(false);
  const [selectedProductForAnalysis, setSelectedProductForAnalysis] = useState<Product | null>(null);
  const [imageAnalysisData, setImageAnalysisData] = useState<any>(null);
  const [analyzingImages, setAnalyzingImages] = useState(false);
  const [analyzingSingleImage, setAnalyzingSingleImage] = useState(false);
  const [analysisError, setAnalysisError] = useState<string | null>(null);
  const [existingAnalysis, setExistingAnalysis] = useState<any>(null);
  const [currentAnalysisData, setCurrentAnalysisData] = useState<any>(null);
  const [productsWithAnalysis, setProductsWithAnalysis] = useState<number[]>([]);
  const [productsWithTitle, setProductsWithTitle] = useState<number[]>([]);
  const [showMarketplaceModal, setShowMarketplaceModal] = useState(false);
  const [showCharacteristicsModal, setShowCharacteristicsModal] = useState(false);
  const [showAnymarketingModal, setShowAnymarketingModal] = useState(false);
  const [showTitleModal, setShowTitleModal] = useState(false);
  const [selectedProductForTool, setSelectedProductForTool] = useState<Product | null>(null);
  
  // Estados para T√≠tulo
  const [generatingTitle, setGeneratingTitle] = useState(false);
  const [generatedTitle, setGeneratedTitle] = useState<string | null>(null);
  const [originalTitle, setOriginalTitle] = useState<string | null>(null);
  const [titleError, setTitleError] = useState<string | null>(null);
  
  // Estados para Marketplace
  const [marketplaceDescription, setMarketplaceDescription] = useState<any>(null);
  const [generatingMarketplace, setGeneratingMarketplace] = useState(false);
  const [productsWithMarketplace, setProductsWithMarketplace] = useState<number[]>([]);
  const [productsWithCharacteristics, setProductsWithCharacteristics] = useState<number[]>([]);
  const [productsWithAnymarketSync, setProductsWithAnymarketSync] = useState<number[]>([]);
  const [productsWithCroppedImages, setProductsWithCroppedImages] = useState<number[]>([]);
  
  // Estados para Caracter√≠sticas
  const [generatingCharacteristics, setGeneratingCharacteristics] = useState(false);
  
  // Estados para filtros
  const [brands, setBrands] = useState<Array<{id: string, name: string}>>([]);
  const [categories, setCategories] = useState<Array<{id: string, name: string}>>([]);
  const [loadingBrands, setLoadingBrands] = useState(false);
  const [loadingCategories, setLoadingCategories] = useState(false);

  // Fun√ß√£o para buscar marcas
  const fetchBrands = useCallback(async () => {
    try {
      setLoadingBrands(true);
      const response = await fetch('/api/filters/brands');
      const data = await response.json();
      if (data.success) {
        setBrands(data.data);
      }
    } catch (error) {
      console.error('Erro ao buscar marcas:', error);
    } finally {
      setLoadingBrands(false);
    }
  }, []);

  // Fun√ß√£o para buscar categorias
  const fetchCategories = useCallback(async () => {
    try {
      setLoadingCategories(true);
      const response = await fetch('/api/filters/categories');
      const data = await response.json();
      if (data.success) {
        setCategories(data.data);
      }
    } catch (error) {
      console.error('Erro ao buscar categorias:', error);
    } finally {
      setLoadingCategories(false);
    }
  }, []);

  // Carregar marcas e categorias quando o componente montar
  useEffect(() => {
    fetchBrands();
    fetchCategories();
  }, [fetchBrands, fetchCategories]);

  const [existingCharacteristics, setExistingCharacteristics] = useState<any[]>([]);
  const [loadingCharacteristics, setLoadingCharacteristics] = useState(false);
  
  // Estados para modal de crop
  const [showCropModal, setShowCropModal] = useState(false);
  const [cropModalData, setCropModalData] = useState<{
    product: any;
    originalImages: any[];
  } | null>(null);

  // Estados para notifica√ß√µes
  const [notifications, setNotifications] = useState<Array<{
    id: string;
    type: 'success' | 'error' | 'warning' | 'info';
    title: string;
    message: string;
    duration?: number;
  }>>([]);


  // Fun√ß√µes para gerenciar notifica√ß√µes
  const addNotification = (type: 'success' | 'error' | 'warning' | 'info', title: string, message: string, duration = 5000) => {
    const id = Date.now().toString();
    const notification = { id, type, title, message, duration };
    
    setNotifications(prev => [...prev, notification]);
    
    // Auto-remover ap√≥s a dura√ß√£o especificada
    setTimeout(() => {
      removeNotification(id);
    }, duration);
  };

  const removeNotification = (id: string) => {
    setNotifications(prev => prev.filter(n => n.id !== id));
  };

  // Estados para modal de SKUs
  const [showSkusModal, setShowSkusModal] = useState(false);
  const [selectedProductId, setSelectedProductId] = useState<number | null>(null);
  
  // Estados para Anymarket Modal
  const [showAnymarketSyncModal, setShowAnymarketSyncModal] = useState(false);
  const [selectedProductForAnymarket, setSelectedProductForAnymarket] = useState<Product | null>(null);
  
  // Estados para an√°lise em lote
  const [batchAnalysisProgress, setBatchAnalysisProgress] = useState({
    current: 0,
    total: 0,
    currentProduct: '',
    isRunning: false
  });

  // Estados para an√°lise do Marketplace em lote
  const [batchMarketplaceProgress, setBatchMarketplaceProgress] = useState({
    current: 0,
    total: 0,
    currentProduct: '',
    isRunning: false
  });

  const [batchAnymarketProgress, setBatchAnymarketProgress] = useState({
    current: 0,
    total: 0,
    currentProduct: '',
    isRunning: false
  });

  // Estados para atualiza√ß√£o de estoque em lote
  const [batchStockProgress, setBatchStockProgress] = useState({
    current: 0,
    total: 0,
    currentProduct: '',
    isRunning: false
  });

  // Estados para gera√ß√£o de caracter√≠sticas em lote
  const [batchCharacteristicsProgress, setBatchCharacteristicsProgress] = useState({
    current: 0,
    total: 0,
    currentProduct: '',
    isRunning: false
  });

  // Estado para exporta√ß√£o
  const [isExporting, setIsExporting] = useState(false);

  // Fun√ß√£o para buscar produtos que j√° t√™m an√°lise
  const fetchProductsWithAnalysis = async () => {
    try {
      // console.log('üîç [DEBUG] fetchProductsWithAnalysis - Iniciando...');
      const response = await fetch('/api/analysis-logs-simple?limit=1000');
      // console.log('üîç [DEBUG] Response status:', response.status);
      
      if (response.ok) {
        const data = await response.json();
        // console.log('üîç [DEBUG] Dados recebidos da API:', data);
        
        if (data.success && data.logs) {
          const productIds = Array.from(new Set(data.logs.map((log: any) => log.product_id))) as number[];
          // console.log('üîç [DEBUG] Product IDs extra√≠dos:', productIds);
          // console.log('üîç [DEBUG] Produto 203723663 est√° na lista?', productIds.includes(203723663));
          setProductsWithAnalysis(productIds);
        } else {
          // console.log('üîç [DEBUG] Nenhum log encontrado ou data.success = false');
          setProductsWithAnalysis([]);
        }
      } else {
        // console.log('üîç [DEBUG] Erro na resposta:', response.status, response.statusText);
      }
    } catch (error) {
      // console.error('üîç [DEBUG] Erro ao buscar produtos com an√°lise:', error);
    }
  };

  // Fun√ß√£o para buscar produtos com t√≠tulo gerado
  const fetchProductsWithTitle = async () => {
    try {
      console.log('üîç Buscando produtos com t√≠tulo gerado...');
      const response = await fetch('/api/titles?status=validated&limit=1000');
      
      if (response.ok) {
        const data = await response.json();
        console.log('üìä Dados recebidos da API titles:', data);
        
        if (data.success && data.data) {
          const productIds = data.data.map((item: any) => item.id_product_vtex) as number[];
          console.log('‚úÖ Produtos com t√≠tulo gerado:', productIds);
          setProductsWithTitle(productIds);
        } else {
          console.log('‚ö†Ô∏è Nenhum t√≠tulo encontrado ou dados inv√°lidos');
          setProductsWithTitle([]);
        }
      } else {
        console.error('Erro ao buscar produtos com t√≠tulo:', response.status, response.statusText);
        setProductsWithTitle([]);
      }
    } catch (error) {
      console.error('Erro ao buscar produtos com t√≠tulo:', error);
      setProductsWithTitle([]);
    }
  };

  // Fun√ß√£o para buscar produtos que j√° t√™m descri√ß√£o do Marketplace
  const fetchProductsWithMarketplace = async () => {
    try {
      console.log('üîç [DEBUG] Iniciando busca de produtos com descri√ß√£o do Marketplace...');
      const response = await fetch('/api/descriptions?status=generated&limit=1000');
      console.log('üîç [DEBUG] Response status:', response.status);
      
      if (response.ok) {
        const data = await response.json();
        console.log('üìä [DEBUG] Resposta da API marketplace:', data);
        if (data.success) {
          const productIds = data.data.map((item: any) => parseInt(item.id_product_vtex));
          console.log('üìã [DEBUG] Product IDs com marketplace:', productIds);
          console.log('üìã [DEBUG] Tipo dos IDs:', productIds.map((id: number) => typeof id));
          setProductsWithMarketplace(productIds);
          console.log('üìã [DEBUG] Estado atualizado com sucesso');
        } else {
          console.log('‚ùå [DEBUG] API retornou success: false');
        }
      } else {
        console.error('‚ùå [DEBUG] Erro na resposta da API marketplace:', response.status);
      }
    } catch (error) {
      console.error('‚ùå [DEBUG] Erro ao buscar produtos com descri√ß√£o do Marketplace:', error);
    }
  };

  // Fun√ß√£o para buscar produtos que j√° t√™m caracter√≠sticas
  const fetchProductsWithCharacteristics = async () => {
    try {
      // console.log('üîç Buscando produtos com caracter√≠sticas...');
      const response = await fetch('/api/respostas-caracteristicas');
      if (response.ok) {
        const data = await response.json();
        // console.log('üìä Resposta da API caracter√≠sticas:', data);
        if (data.success) {
          const productIds = Array.from(new Set(data.data.map((item: any) => item.produto_id))) as number[];
          // console.log('üìã Product IDs com caracter√≠sticas:', productIds);
          setProductsWithCharacteristics(productIds);
        }
      } else {
        // console.error('‚ùå Erro na resposta da API caracter√≠sticas:', response.status);
      }
    } catch (error) {
      // console.error('Erro ao buscar produtos com caracter√≠sticas:', error);
    }
  };

  // Fun√ß√£o para buscar produtos que j√° foram sincronizados com Anymarket
  const fetchProductsWithAnymarketSync = async () => {
    try {
      // console.log('üîç [ANYMARKET SYNC] Iniciando busca de produtos com mapeamento...');
      
      // Buscar produtos que t√™m mapeamento na tabela anymarket
      const response = await fetch('/api/anymarket/mapped-products');
      // console.log('üì° [ANYMARKET SYNC] Response status:', response.status);
      
      if (response.ok) {
        const data = await response.json();
        // console.log('üìä [ANYMARKET SYNC] Resposta da API:', data);
        // console.log('üìä [ANYMARKET SYNC] Data length:', data.data?.length);
        
        if (data.success && data.data) {
          const productIds = data.data.map((product: any) => Number(product.id)) as number[];
          // console.log('üìã [ANYMARKET SYNC] Product IDs extra√≠dos:', productIds);
          // console.log('üìã [ANYMARKET SYNC] Total de produtos mapeados:', productIds.length);
          // console.log('üìã [ANYMARKET SYNC] Produto 203721565 est√° na lista?', productIds.includes(203721565));
          
          setProductsWithAnymarketSync(productIds);
          // console.log('‚úÖ [ANYMARKET SYNC] Estado atualizado com sucesso!');
        } else {
          // console.log('‚ùå [ANYMARKET SYNC] API retornou success: false ou data vazia');
          setProductsWithAnymarketSync([]);
        }
      } else {
        // console.error('‚ùå [ANYMARKET SYNC] Erro na resposta da API:', response.status);
        setProductsWithAnymarketSync([]);
      }
    } catch (error) {
      // console.error('‚ùå [ANYMARKET SYNC] Erro ao buscar produtos:', error);
      setProductsWithAnymarketSync([]);
    }
  };

  // Hooks do m√≥dulo
  const {
    products,
    loading,
    error,
    currentPage,
    totalPages,
    totalProducts,
    filters,
    sort,
    itemsPerPage,
    anymarketMappings,
    fetchProducts,
    updateFilters,
    clearFilters,
    updateSort,
    updatePage,
    updateItemsPerPage,
    deleteProduct,
    deleteMultipleProducts,
    hasProducts,
    hasFilters
  } = useProducts();

  // Buscar produtos com an√°lise, descri√ß√£o do Marketplace e sincroniza√ß√£o Anymarket quando a p√°gina carregar
  // Fun√ß√£o para buscar produtos com crop processado
  const fetchProductsWithCroppedImages = async () => {
    try {
      console.log('üîç Buscando produtos com crop processado...');
      const response = await fetch('/api/crop-logs?status=completed&limit=1000');
      
      if (response.ok) {
        const data = await response.json();
        console.log('üìä Dados recebidos da API crop-logs:', data);
        
        if (data.success && data.logs) {
          const productIds = Array.from(new Set(data.logs.map((log: any) => log.product_id))) as number[];
          console.log('‚úÖ Produtos com crop processado:', productIds);
          console.log('üîÑ Estado anterior productsWithCroppedImages:', productsWithCroppedImages);
          setProductsWithCroppedImages(productIds);
          console.log('üîÑ Estado atualizado para:', productIds);
        } else {
          console.log('‚ö†Ô∏è Nenhum log encontrado ou dados inv√°lidos');
          setProductsWithCroppedImages([]);
        }
      } else {
        console.error('Erro ao buscar produtos com crop:', response.status, response.statusText);
        setProductsWithCroppedImages([]);
      }
    } catch (error) {
      console.error('Erro ao buscar produtos com crop:', error);
      setProductsWithCroppedImages([]);
    }
  };

  useEffect(() => {
    const fetchAllData = async () => {
      try {
        await Promise.all([
          fetchProductsWithAnalysis(),
          fetchProductsWithTitle(),
          fetchProductsWithMarketplace(),
          fetchProductsWithCharacteristics(),
          fetchProductsWithAnymarketSync(),
          fetchProductsWithCroppedImages()
        ]);
      } catch (error) {
        // console.error('Erro ao carregar dados iniciais:', error);
      }
    };
    
    fetchAllData();
  }, []);

  // Debug: monitorar mudan√ßas no estado productsWithCroppedImages
  useEffect(() => {
    console.log('üîç [DEBUG] productsWithCroppedImages mudou:', productsWithCroppedImages);
  }, [productsWithCroppedImages]);

  // Debug: verificar productsWithAnalysis quando muda (apenas em desenvolvimento) - removido
  // useEffect(() => {
  //   if (process.env.NODE_ENV === 'development') {
  //     console.log('üîç [DEBUG] productsWithAnalysis atualizado:', productsWithAnalysis);
  //   }
  // }, [productsWithAnalysis]);


  const {
    showModal,
    selectedProduct,
    productSKUs,
    productImages,
    productSyncLogs,
    modalLoading,
    copiedText,
    openModal,
    closeModal,
    copyToClipboard
  } = useProductModal();

  // Fun√ß√µes de sele√ß√£o memoizadas
  const handleSelectProduct = useCallback((productId: number) => {
    setSelectedProducts(prev => 
      prev.includes(productId) 
        ? prev.filter(id => id !== productId)
        : [...prev, productId]
    );
  }, []);

  const handleSelectAll = useCallback(() => {
    if (selectedProducts.length === products.length) {
      setSelectedProducts([]);
    } else {
      setSelectedProducts(products.map(p => p.id));
    }
  }, [selectedProducts.length, products]);

  // Fun√ß√µes de a√ß√£o memoizadas
  const handleViewProduct = useCallback((product: Product) => {
    // Debug removido
    // if (process.env.NODE_ENV === 'development') {
    //   console.log('üëÅÔ∏è Clicou em ver detalhes do produto:', product.name, 'ID:', product.id);
    // }
    openModal(product);
  }, [openModal]);

  // Fun√ß√£o de edi√ß√£o removida

  const handleDeleteProduct = useCallback(async (product: Product) => {
    if (confirm(`Tem certeza que deseja excluir o produto "${product.name}"?`)) {
      const success = await deleteProduct(product.id);
      if (success) {
        setSelectedProducts(prev => prev.filter(id => id !== product.id));
      }
    }
  }, [deleteProduct]);

  const handleDeleteSelected = useCallback(async () => {
    if (selectedProducts.length === 0) return;
    
    if (confirm(`Tem certeza que deseja excluir ${selectedProducts.length} produtos?`)) {
      const success = await deleteMultipleProducts(selectedProducts);
      if (success) {
        setSelectedProducts([]);
      }
    }
  }, [selectedProducts, deleteMultipleProducts]);

  const handleAnalyzeSelectedImages = async () => {
    if (selectedProducts.length === 0) return;
    
    if (confirm(`Deseja analisar as imagens de ${selectedProducts.length} produtos selecionados?`)) {
      // Encontrar os produtos selecionados
      const selectedProductsData = products.filter(p => selectedProducts.includes(p.id));
      
      // Inicializar progresso
      setBatchAnalysisProgress({
        current: 0,
        total: selectedProductsData.length,
        currentProduct: '',
        isRunning: true
      });
      
      // N√£o usar setAnalyzingSingleImage(true) para an√°lise em lote - apenas para an√°lise individual
      
      try {
        let successCount = 0;
        let errorCount = 0;
        
        // Analisar cada produto sequencialmente
        for (let i = 0; i < selectedProductsData.length; i++) {
          const product = selectedProductsData[i];
          
          try {
            // Atualizar progresso
            setBatchAnalysisProgress(prev => ({
              ...prev,
              current: i + 1,
              currentProduct: product.name
            }));
            
            // console.log(`üîÑ Analisando produto ${i + 1}/${selectedProductsData.length}: ${product.name}`);
            
            // Chamar API diretamente
            const timestamp = Date.now();
            const response = await fetch('/api/analyze-images', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ 
                productId: product.id,
                timestamp: timestamp,
                forceNewAnalysis: true,
                categoryVtexId: product.category_vtex_id
              }),
            });

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            
            if (result.success) {
              // console.log(`‚úÖ An√°lise conclu√≠da para: ${product.name}`);
              
              // Atualizar lista de produtos com an√°lise em tempo real
              setProductsWithAnalysis(prev => {
                if (!prev.includes(product.id)) {
                  // console.log(`‚úÖ Adicionando produto ${product.id} √† lista de produtos com an√°lise`);
                  return [...prev, product.id];
                }
                return prev;
              });
              
              successCount++;
            } else {
              // console.error(`‚ùå Falha na an√°lise para: ${product.name}`, result.error);
              errorCount++;
            }
            
            // Pequena pausa entre an√°lises para n√£o sobrecarregar a API
            await new Promise(resolve => setTimeout(resolve, 1500));
            
          } catch (error) {
            // console.error(`‚ùå Erro ao analisar produto ${product.name}:`, error);
            errorCount++;
          }
        }
        
        // Mostrar resultado final
        alert(`An√°lise em lote conclu√≠da!\n‚úÖ Sucessos: ${successCount}\n‚ùå Erros: ${errorCount}`);
        
        // Limpar sele√ß√£o ap√≥s an√°lise
        setSelectedProducts([]);
        
        // Lista j√° foi atualizada em tempo real durante o processamento
        
      } catch (error) {
        // console.error('Erro na an√°lise em lote:', error);
        alert('Erro durante a an√°lise em lote. Verifique o console para mais detalhes.');
      } finally {
        setAnalyzingSingleImage(false);
        setBatchAnalysisProgress({
          current: 0,
          total: 0,
          currentProduct: '',
          isRunning: false
        });
      }
    }
  };

  // Fun√ß√£o para sincronizar com Anymarket em lote
  const handleAnymarketSyncBatch = async () => {
    if (selectedProducts.length === 0) return;
    
    if (confirm(`Deseja sincronizar ${selectedProducts.length} produtos selecionados com o Anymarket?`)) {
      // Inicializar progresso
      setBatchAnymarketProgress({
        current: 0,
        total: selectedProducts.length,
        currentProduct: '',
        isRunning: true
      });

      try {
        // console.log(`üîÑ Iniciando sincroniza√ß√£o em lote com Anymarket para ${selectedProducts.length} produtos`);

        // Chamar API de sincroniza√ß√£o em lote de t√≠tulos
        const response = await fetch('/api/anymarket/sync-title-batch', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            productIds: selectedProducts
          })
        });

        // console.log('üì° Resposta recebida, status:', response.status);
        const result = await response.json();

        if (response.ok && result.success) {
          // console.log('‚úÖ Sincroniza√ß√£o em lote conclu√≠da:', result.data);
          alert(`‚úÖ Sincroniza√ß√£o em lote conclu√≠da!\n\nSucessos: ${result.data.success}\nFalhas: ${result.data.failed}\nTotal: ${result.data.total}`);
          
          // Recarregar lista de produtos
          await fetchProducts();
        } else {
          // console.error('‚ùå Erro na sincroniza√ß√£o em lote:', result.message);
          alert('‚ùå Erro na sincroniza√ß√£o em lote: ' + result.message);
        }
      } catch (error) {
        // console.error('‚ùå Erro ao sincronizar com Anymarket em lote:', error);
        alert('‚ùå Erro ao sincronizar com Anymarket em lote: ' + (error as Error).message);
      } finally {
        setBatchAnymarketProgress({
          current: 0,
          total: 0,
          currentProduct: '',
          isRunning: false
        });
      }
    }
  };

  // Fun√ß√£o para gerar descri√ß√µes do Marketplace em lote
  const handleGenerateMeliBatch = async () => {
    if (selectedProducts.length === 0) return;
    
    if (confirm(`Deseja gerar descri√ß√µes do Marketplace para ${selectedProducts.length} produtos selecionados?`)) {
      // Encontrar os produtos selecionados
      const selectedProductsData = products.filter(p => selectedProducts.includes(p.id));
      
      // Inicializar progresso
      setBatchMarketplaceProgress({
        current: 0,
        total: selectedProductsData.length,
        currentProduct: '',
        isRunning: true
      });

      try {
        let successCount = 0;
        let errorCount = 0;
        
        // Gerar descri√ß√£o para cada produto sequencialmente
        for (let i = 0; i < selectedProductsData.length; i++) {
          const product = selectedProductsData[i];
          
          try {
            // Atualizar progresso
            setBatchMarketplaceProgress(prev => ({
              ...prev,
              current: i + 1,
              currentProduct: product.name
            }));

            // console.log(`üîÑ Gerando descri√ß√£o do Marketplace para produto ${i + 1}/${selectedProductsData.length}: ${product.name}`);

            // Gerar descri√ß√£o do Marketplace
            const response = await fetch('/api/generate-description', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                productId: product.id,
                forceRegenerate: false
              })
            });

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            
            if (result.success) {
              // console.log(`‚úÖ Descri√ß√£o do Marketplace gerada para: ${product.name}`);
              
              // Atualizar lista de produtos com Marketplace em tempo real
              setProductsWithMarketplace(prev => {
                if (!prev.includes(product.id)) {
                  // console.log(`‚úÖ Adicionando produto ${product.id} √† lista de produtos com Marketplace`);
                  return [...prev, product.id];
                }
                return prev;
              });
              
              successCount++;
            } else {
              // console.error(`‚ùå Falha na gera√ß√£o para: ${product.name}`, result.error);
              errorCount++;
            }

            // Pequena pausa entre as requisi√ß√µes
            await new Promise(resolve => setTimeout(resolve, 1500));

          } catch (error) {
            // console.error(`‚ùå Erro ao processar produto ${product.name}:`, error);
            errorCount++;
          }
        }

        // Mostrar resultado final
        alert(`Gera√ß√£o de descri√ß√µes do Marketplace conclu√≠da!\n‚úÖ Sucessos: ${successCount}\n‚ùå Erros: ${errorCount}`);
        
        // Lista j√° foi atualizada em tempo real durante o processamento
        
        // Limpar sele√ß√£o ap√≥s gera√ß√£o
        setSelectedProducts([]);

      } catch (error) {
        // console.error('Erro na gera√ß√£o em lote do Marketplace:', error);
        alert('Erro durante a gera√ß√£o em lote do Marketplace. Verifique o console para mais detalhes.');
      } finally {
        setBatchMarketplaceProgress({
          current: 0,
          total: 0,
          currentProduct: '',
          isRunning: false
        });
      }
    }
  };

  // Fun√ß√£o para gerar caracter√≠sticas em lote
  const handleGenerateCharacteristicsBatch = async () => {
    if (selectedProducts.length === 0) return;
    
    if (confirm(`Deseja gerar caracter√≠sticas para ${selectedProducts.length} produtos selecionados?`)) {
      // Encontrar os produtos selecionados
      const selectedProductsData = products.filter(p => selectedProducts.includes(p.id));
      
      // Inicializar progresso
      setBatchCharacteristicsProgress({
        current: 0,
        total: selectedProductsData.length,
        currentProduct: '',
        isRunning: true
      });
      
      try {
        let successCount = 0;
        let errorCount = 0;
        
        // Gerar caracter√≠sticas para cada produto sequencialmente
        for (let i = 0; i < selectedProductsData.length; i++) {
          const product = selectedProductsData[i];
          
          try {
            // Atualizar progresso
            setBatchCharacteristicsProgress(prev => ({
              ...prev,
              current: i + 1,
              currentProduct: product.name
            }));
            
            console.log(`ü§ñ Gerando caracter√≠sticas para produto ${i + 1}/${selectedProductsData.length}: ${product.name}`);
            
            // Gerar caracter√≠sticas
            const response = await fetch('/api/generate-characteristics', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                productId: product.id
              })
            });

            if (response.ok) {
              const result = await response.json();
              if (result.success) {
                successCount++;
                console.log(`‚úÖ Caracter√≠sticas geradas para ${product.name}`);
              } else {
                errorCount++;
                console.error(`‚ùå Erro ao gerar caracter√≠sticas para ${product.name}:`, result.message);
              }
            } else {
              errorCount++;
              console.error(`‚ùå Erro HTTP ao gerar caracter√≠sticas para ${product.name}:`, response.status);
            }
          } catch (error) {
            errorCount++;
            console.error(`‚ùå Erro ao gerar caracter√≠sticas para ${product.name}:`, error);
          }
        }
        
        // Mostrar resultado final
        alert(`Gera√ß√£o de caracter√≠sticas em lote conclu√≠da!\n‚úÖ Sucessos: ${successCount}\n‚ùå Erros: ${errorCount}`);
        
        // Limpar sele√ß√£o ap√≥s gera√ß√£o
        setSelectedProducts([]);
        
        // Atualizar lista de produtos com caracter√≠sticas
        await fetchProductsWithCharacteristics();
        
      } catch (error) {
        console.error('Erro na gera√ß√£o de caracter√≠sticas em lote:', error);
        alert('Erro durante a gera√ß√£o de caracter√≠sticas em lote. Verifique o console para mais detalhes.');
      } finally {
        setBatchCharacteristicsProgress({
          current: 0,
          total: 0,
          currentProduct: '',
          isRunning: false
        });
      }
    }
  };

  // Fun√ß√£o para atualizar estoque em lote
  const handleUpdateStockBatch = async () => {
    if (selectedProducts.length === 0) return;
    
    if (confirm(`Deseja atualizar o estoque de ${selectedProducts.length} produtos selecionados?`)) {
      // Encontrar os produtos selecionados
      const selectedProductsData = products.filter(p => selectedProducts.includes(p.id));
      
      // Inicializar progresso
      setBatchStockProgress({
        current: 0,
        total: selectedProductsData.length,
        currentProduct: '',
        isRunning: true
      });

      try {
        let successCount = 0;
        let errorCount = 0;
        
        // Processar cada produto sequencialmente
        for (let i = 0; i < selectedProductsData.length; i++) {
          const product = selectedProductsData[i];
          
          try {
            // Atualizar progresso
            setBatchStockProgress(prev => ({
              ...prev,
              current: i + 1,
              currentProduct: product.name
            }));
            
            // console.log(`üîÑ Atualizando estoque do produto ${i + 1}/${selectedProductsData.length}: ${product.name}`);
            
            // Chamar API para atualizar estoque
            const response = await fetch(`/api/products/${product.id}/stock`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
            });

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            
            if (result.success) {
              // console.log(`‚úÖ Estoque atualizado para: ${product.name}`);
              successCount++;
            } else {
              // console.error(`‚ùå Falha na atualiza√ß√£o para: ${product.name}`, result.error);
              errorCount++;
            }
            
            // Pequena pausa entre atualiza√ß√µes para n√£o sobrecarregar a API
            await new Promise(resolve => setTimeout(resolve, 1000));
            
          } catch (error) {
            // console.error(`‚ùå Erro ao atualizar estoque para ${product.name}:`, error);
            errorCount++;
          }
        }
        
        // Finalizar progresso
        setBatchStockProgress(prev => ({
          ...prev,
          isRunning: false
        }));
        
        // Recarregar dados
        await fetchProducts();
        
        // Mostrar resultado
        alert(`Atualiza√ß√£o de estoque conclu√≠da!\n‚úÖ Sucessos: ${successCount}\n‚ùå Erros: ${errorCount}`);
        
      } catch (error) {
        // console.error('‚ùå Erro na atualiza√ß√£o de estoque em lote:', error);
        setBatchStockProgress(prev => ({
          ...prev,
          isRunning: false
        }));
        alert('Erro durante a atualiza√ß√£o de estoque em lote');
      }
    }
  };

  // Fun√ß√£o para exportar produtos selecionados para XLSX
  const handleExportSelected = async () => {
    if (selectedProducts.length === 0) return;
    
    setIsExporting(true);
    
    try {
      // Buscar dados completos dos produtos selecionados
      const selectedProductsData = products.filter(p => selectedProducts.includes(p.id));
      
      // Preparar dados para exporta√ß√£o
      const exportData = selectedProductsData.map(product => ({
        'ID': product.id,
        'Nome': product.name,
        'T√≠tulo': product.title || '',
        'RefId': product.ref_id || '',
        'ID Anymarket': product.anymarket_id || '',
        'Marca': product.brand_name || '',
        'Categoria': product.category_name || '',
        'Departamento': product.department_name || '',
        'SKUs / Estoque': `${product.sku_count || 0} / ${product.total_stock || 0}`,
        'Imagens': product.image_count || 0,
        'Ativo': product.is_active ? 'Sim' : 'N√£o',
        'Vis√≠vel': product.is_visible ? 'Sim' : 'N√£o',
        'Data Cria√ß√£o': product.created_at ? new Date(product.created_at).toLocaleDateString('pt-BR') : '',
        'Data Atualiza√ß√£o': product.updated_at ? new Date(product.updated_at).toLocaleDateString('pt-BR') : ''
      }));

      // Criar workbook
      const workbook = XLSX.utils.book_new();
      const worksheet = XLSX.utils.json_to_sheet(exportData);

      // Configurar largura das colunas
      const columnWidths = [
        { wch: 8 },   // ID
        { wch: 40 },  // Nome
        { wch: 30 },  // T√≠tulo
        { wch: 15 },  // RefId
        { wch: 15 },  // ID Anymarket
        { wch: 20 },  // Marca
        { wch: 25 },  // Categoria
        { wch: 20 },  // Departamento
        { wch: 15 },  // SKUs / Estoque
        { wch: 10 },  // Imagens
        { wch: 8 },   // Ativo
        { wch: 10 },  // Vis√≠vel
        { wch: 12 },  // Data Cria√ß√£o
        { wch: 12 }   // Data Atualiza√ß√£o
      ];
      worksheet['!cols'] = columnWidths;

      // Adicionar worksheet ao workbook
      XLSX.utils.book_append_sheet(workbook, worksheet, 'Produtos');

      // Gerar nome do arquivo com timestamp
      const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
      const fileName = `produtos_selecionados_${timestamp}.xlsx`;

      // Exportar arquivo
      XLSX.writeFile(workbook, fileName);

      // console.log(`‚úÖ Arquivo exportado: ${fileName}`);
      // console.log(`üìä ${selectedProductsData.length} produtos exportados`);

    } catch (error) {
      // console.error('‚ùå Erro ao exportar produtos:', error);
      alert('Erro ao exportar produtos. Verifique o console para mais detalhes.');
    } finally {
      setIsExporting(false);
    }
  };

  const handleAnalyzeImages = async (product: Product) => {
    setSelectedProductForAnalysis(product);
    
    // Verificar se j√° existe uma an√°lise para este produto
    try {
      const response = await fetch(`/api/analysis-logs-simple?productId=${product.id}&limit=1`);
      if (response.ok) {
        const data = await response.json();
        if (data.success && data.logs && data.logs.length > 0) {
          // Existe an√°lise, carregar dados e mostrar modal
          const analysisLog = data.logs[0];
          
          // Construir dados da an√°lise no formato esperado
          const analysisData = {
            product: product,
            agent_used: analysisLog.agent_name || "Agente de Imagens",
            analysis: {
              product_type: analysisLog.product_type || 'produto',
              image_count: analysisLog.image_count || 0,
              invalid_image_count: analysisLog.invalid_image_count || 0,
              contextual_analysis: analysisLog.contextual_analysis,
              analysis_quality: {
                level: analysisLog.analysis_quality || 'alta'
              },
              agent_configuration: {
                model: analysisLog.model_used || 'gpt-4o',
                max_tokens: analysisLog.max_tokens || 2000,
                quality_level: 'alta'
              },
              openai_analysis: {
                tokens_used: analysisLog.tokens_used || 0
              }
            },
            product_attributes: analysisLog.product_attributes || [], // Incluir atributos do produto
            analysis_log: {
              duration_ms: analysisLog.analysis_duration_ms || 0,
              openai_response_time_ms: analysisLog.openai_response_time_ms || 0,
              tokens_used: analysisLog.tokens_used || 0,
              openai_cost: analysisLog.openai_cost || 0,
              analysis_type: analysisLog.analysis_type || 'openai'
            }
          };
          
          setCurrentAnalysisData(analysisData);
          setShowImageAnalysisModal(true);
        } else {
          // N√£o existe an√°lise, mostrar modal para gerar nova
          setCurrentAnalysisData(null);
          setShowImageAnalysisModal(true);
        }
      } else {
        // Erro na API, mostrar modal para gerar nova an√°lise
        setCurrentAnalysisData(null);
        setShowImageAnalysisModal(true);
      }
    } catch (error) {
      // console.error('Erro ao verificar an√°lise existente:', error);
      // Em caso de erro, mostrar modal para gerar nova an√°lise
      setCurrentAnalysisData(null);
      setShowImageAnalysisModal(true);
    }
  };

  const handleGenerateTitle = async (product: Product) => {
    setSelectedProductForTool(product);
    setTitleError(null);
    setOriginalTitle(product.name); // Armazenar t√≠tulo original do produto
    setShowTitleModal(true);
    
    // Buscar t√≠tulo existente se houver
    try {
      const response = await fetch(`/api/titles?productId=${product.id}&status=validated&limit=1`);
      if (response.ok) {
        const data = await response.json();
        if (data.success && data.data.length > 0) {
          setGeneratedTitle(data.data[0].title);
          console.log('üìù T√≠tulo existente encontrado:', data.data[0].title);
        } else {
          setGeneratedTitle(null);
        }
      } else {
        setGeneratedTitle(null);
      }
    } catch (error) {
      console.error('‚ùå Erro ao buscar t√≠tulo existente:', error);
      setGeneratedTitle(null);
    }
  };

  const handleStartTitleGeneration = async (forceRegenerate = false) => {
    // Corrigir se forceRegenerate for um evento
    if (forceRegenerate && typeof forceRegenerate === 'object' && (forceRegenerate as any).preventDefault) {
      forceRegenerate = true;
    }
    
    console.log('üîç handleStartTitleGeneration chamada:', { 
      selectedProductForTool: selectedProductForTool?.name, 
      generatingTitle, 
      forceRegenerate 
    });
    
    if (!selectedProductForTool) {
      console.error('‚ùå selectedProductForTool n√£o est√° definido');
      setTitleError('Produto n√£o selecionado. Feche e abra o modal novamente.');
      return;
    }
    
    if (generatingTitle) {
      console.log('‚ö†Ô∏è J√° est√° gerando t√≠tulo, ignorando clique');
      return;
    }
    
    setGeneratingTitle(true);
    setTitleError(null);
    
    try {
      console.log(`üéØ Gerando t√≠tulo para produto: ${selectedProductForTool.name} (ID: ${selectedProductForTool.id}) - Force: ${forceRegenerate}`);
      
      const response = await fetch('/api/generate-title', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          productId: selectedProductForTool.id,
          forceRegenerate: forceRegenerate
        }),
      });

      if (response.ok) {
        const data = await response.json();
        if (data.success) {
          console.log('‚úÖ T√≠tulo gerado com sucesso:', data.data.title);
          setGeneratedTitle(data.data.title);
          
          // Atualizar a lista de produtos com t√≠tulo
          setProductsWithTitle(prev => [...prev, selectedProductForTool.id]);
          
          // Mostrar notifica√ß√£o de sucesso
          addNotification(
            'success', 
            'T√≠tulo Gerado!', 
            `T√≠tulo gerado com sucesso para ${selectedProductForTool.name}`,
            5000
          );
        } else {
          console.error('‚ùå Erro ao gerar t√≠tulo:', data.message);
          setTitleError(data.message);
        }
      } else {
        console.error('‚ùå Erro na resposta da API:', response.status, response.statusText);
        let errorMessage = 'Erro desconhecido';
        try {
          const errorData = await response.json();
          errorMessage = errorData.message || errorData.error || 'Erro na API';
          console.error('‚ùå Detalhes do erro:', errorData);
        } catch (parseError) {
          console.error('‚ùå Erro ao fazer parse da resposta de erro:', parseError);
          errorMessage = `Erro ${response.status}: ${response.statusText}`;
        }
        setTitleError(errorMessage);
      }
    } catch (error) {
      console.error('‚ùå Erro ao gerar t√≠tulo:', error);
      setTitleError(`Erro ao gerar t√≠tulo: ${error instanceof Error ? error.message : 'Erro desconhecido'}`);
    } finally {
      setGeneratingTitle(false);
    }
  };

  // Fun√ß√£o para gerar nova an√°lise de imagens
  const handleGenerateNewAnalysis = async (forceRegenerate = false) => {
    if (!selectedProductForAnalysis) return;

    console.log('üîÑ Iniciando an√°lise para produto:', selectedProductForAnalysis.name, 'ID:', selectedProductForAnalysis.id);

    try {
      setAnalyzingSingleImage(true);
      setAnalysisError(null);
      
      // Adicionar timestamp para evitar cache
      const timestamp = Date.now();
      
      console.log('üì° Enviando requisi√ß√£o para API...');
      const response = await fetch('/api/analyze-images', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
          productId: selectedProductForAnalysis.id,
          timestamp: timestamp,
          forceNewAnalysis: forceRegenerate,
          categoryVtexId: selectedProductForAnalysis.category_vtex_id
        }),
      });

      console.log('üì° Resposta recebida, status:', response.status);
      const result = await response.json();

      if (result.success) {
        console.log('‚úÖ Nova an√°lise gerada:', result);
        setCurrentAnalysisData(result);
        
        // Atualizar lista de produtos com an√°lise
        if (selectedProductForAnalysis) {
          setProductsWithAnalysis(prev => Array.from(new Set([...prev, selectedProductForAnalysis.id])));
        }
      } else {
        console.log('‚ùå Erro na an√°lise:', result.message);
        setAnalysisError(result.message || 'Erro ao analisar imagens');
      }
    } catch (error) {
      console.error('‚ùå Erro na an√°lise:', error);
      setAnalysisError('Erro ao analisar imagens');
    } finally {
      setAnalyzingSingleImage(false);
    }
  };

  const handleViewExistingAnalysis = async () => {
    if (!selectedProductForAnalysis || !existingAnalysis) {
      console.log('‚ùå Nenhum produto ou an√°lise selecionada');
      return;
    }

    try {
      setAnalyzingSingleImage(true);
      setAnalysisError(null);
      
      // Buscar dados completos da an√°lise
      const response = await fetch(`/api/analysis-logs/${existingAnalysis.id}`);
      if (response.ok) {
        const data = await response.json();
        if (data.success && data.log) {
          // Simular estrutura de dados da an√°lise para compatibilidade
          setImageAnalysisData({
            product: selectedProductForAnalysis,
            analysis: {
              product_type: data.log.product_type || 'produto',
              image_count: data.log.valid_images || 0,
              invalid_image_count: data.log.invalid_images || 0,
              contextual_analysis: data.log.analysis_text || 'An√°lise n√£o dispon√≠vel',
              analysis_quality: {
                level: data.log.analysis_quality || 'media',
                description: `An√°lise ${data.log.analysis_type || 't√©cnica'} com ${data.log.model_used || 'GPT-4o'}`
              },
              agent_configuration: {
                model: data.log.model_used || 'gpt-4o',
                max_tokens: data.log.max_tokens || 2000,
                temperature: data.log.temperature || 0.7,
                quality_level: data.log.analysis_quality || 'media',
                quality_description: `An√°lise ${data.log.analysis_type || 't√©cnica'} com ${data.log.model_used || 'GPT-4o'}`
              },
              openai_analysis: {
                openai_analysis: data.log.analysis_text || 'An√°lise n√£o dispon√≠vel',
                model_used: data.log.model_used || 'gpt-4o',
                tokens_used: data.log.tokens_used || 0,
                response_time_ms: data.log.openai_response_time_ms || 0
              },
              image_analysis: {
                total_images: data.log.total_images || 0,
                valid_images: data.log.valid_images || 0,
                invalid_images: data.log.invalid_images || 0,
                lighting: "Ilumina√ß√£o profissional adequada",
                clarity: "Alta resolu√ß√£o e nitidez",
                angles: (data.log.valid_images || 0) > 1 ? "M√∫ltiplos √¢ngulos de visualiza√ß√£o" : "Visualiza√ß√£o √∫nica",
                background: "Fundo neutro profissional",
                composition: "Composi√ß√£o equilibrada e atrativa"
              }
            },
            images: [], // N√£o temos as imagens na an√°lise existente
            invalid_images: [],
            agent_used: "Agente de Imagens",
            analysis_log: {
              duration_ms: data.log.analysis_duration_ms || 0,
              openai_response_time_ms: data.log.openai_response_time_ms || 0,
              tokens_used: data.log.tokens_used || 0,
              analysis_type: data.log.analysis_type || 'openai'
            }
          });
          
          setShowAnalysisSelectionModal(false);
          setShowImageAnalysisModal(true);
        } else {
          setAnalysisError('Erro ao carregar an√°lise existente');
        }
      } else {
        setAnalysisError('Erro ao buscar an√°lise existente');
      }
    } catch (error) {
      console.error('Erro ao visualizar an√°lise existente:', error);
      setAnalysisError('Erro ao carregar an√°lise existente');
    } finally {
      setAnalyzingSingleImage(false);
    }
  };

  // Fun√ß√µes para as ferramentas
  const handleGenerateMarketplaceDescription = async (product: Product) => {
    setSelectedProductForTool(product);
    
    // Verificar se j√° existe descri√ß√£o
    try {
      const response = await fetch(`/api/descriptions?productId=${product.id}&status=generated&limit=1`);
      if (response.ok) {
        const data = await response.json();
        if (data.success && data.data.length > 0) {
          setMarketplaceDescription(data.data[0]);
        } else {
          setMarketplaceDescription(null);
        }
      }
    } catch (error) {
      console.error('Erro ao verificar descri√ß√£o existente:', error);
      setMarketplaceDescription(null);
    }
    
    setShowMarketplaceModal(true);
  };

  const handleGenerateCharacteristics = async (product: Product) => {
    setSelectedProductForTool(product);
    
    // Verificar se o produto tem an√°lise de imagem
    const hasImageAnalysis = productsWithAnalysis.includes(product.id);
    if (!hasImageAnalysis) {
      addNotification('warning', 'Pr√©-requisito necess√°rio', 'Este produto precisa ter an√°lise de imagem antes de gerar caracter√≠sticas. Execute a an√°lise de imagem primeiro.');
      return;
    }
    
    // Verificar se o produto tem descri√ß√£o do marketplace
    const hasMarketplaceDescription = productsWithMarketplace.includes(product.id);
    if (!hasMarketplaceDescription) {
      addNotification('warning', 'Pr√©-requisito necess√°rio', 'Este produto precisa ter descri√ß√£o do marketplace antes de gerar caracter√≠sticas. Execute a gera√ß√£o de descri√ß√£o do marketplace primeiro.');
      return;
    }
    
    // Verificar se o produto tem categoria definida
    if (!product.category_id) {
      addNotification('error', 'Categoria n√£o definida', 'Este produto n√£o possui categoria definida. N√£o √© poss√≠vel gerar caracter√≠sticas sem categoria.');
      return;
    }
    
    // Carregar dados do marketplace
    try {
      const marketplaceResponse = await fetch(`/api/marketplace?productId=${product.id}`);
      if (marketplaceResponse.ok) {
        const marketplaceResult = await marketplaceResponse.json();
        if (marketplaceResult.success && marketplaceResult.data) {
          setMarketplaceDescription(marketplaceResult.data);
        }
      }
    } catch (error) {
      console.error('Erro ao carregar dados do marketplace:', error);
    }


    // Carregar caracter√≠sticas existentes se houver
    const hasExistingCharacteristics = productsWithCharacteristics.includes(product.id);
    if (hasExistingCharacteristics) {
      setLoadingCharacteristics(true);
      try {
        const response = await fetch(`/api/respostas-caracteristicas?productId=${product.id}`);
        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            setExistingCharacteristics(result.data || []);
          }
        }
      } catch (error) {
        console.error('Erro ao carregar caracter√≠sticas existentes:', error);
      } finally {
        setLoadingCharacteristics(false);
      }
    } else {
      setExistingCharacteristics([]);
    }
    
    setShowCharacteristicsModal(true);
  };

  const handleStartCharacteristicsGeneration = async () => {
    if (!selectedProductForTool || generatingCharacteristics) return;
    
    setGeneratingCharacteristics(true);
    
    try {
      console.log(`ü§ñ Gerando caracter√≠sticas para produto: ${selectedProductForTool.name} (ID: ${selectedProductForTool.id})`);
      
      const response = await fetch('/api/generate-characteristics', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          productId: selectedProductForTool.id
        }),
      });

      const result = await response.json();
      
      if (result.success) {
        console.log('‚úÖ Caracter√≠sticas geradas com sucesso:', result.data);
        addNotification('success', 'Caracter√≠sticas geradas!', `${result.data.characteristicsGenerated} respostas salvas com sucesso.`);
        
        // Atualizar lista de produtos com caracter√≠sticas
        await fetchProductsWithCharacteristics();
        
        // Recarregar caracter√≠sticas do produto atual no modal
        try {
          const response = await fetch(`/api/respostas-caracteristicas?productId=${selectedProductForTool.id}`);
          if (response.ok) {
            const result = await response.json();
            if (result.success) {
              setExistingCharacteristics(result.data || []);
            }
          }
        } catch (error) {
          console.error('Erro ao recarregar caracter√≠sticas:', error);
        }
      } else {
        console.error('Erro ao gerar caracter√≠sticas:', result.message);
        
        // Verificar se √© erro relacionado √† categoria
        if (result.message.includes('categoria') || result.message.includes('caracter√≠stica est√° configurada')) {
          addNotification('warning', 'Configura√ß√£o necess√°ria', result.message);
        } else {
          addNotification('error', 'Erro ao gerar caracter√≠sticas', result.message);
        }
      }
    } catch (error) {
      console.error('Erro ao gerar caracter√≠sticas:', error);
      addNotification('error', 'Erro ao gerar caracter√≠sticas', 'Ocorreu um erro inesperado. Tente novamente.');
    } finally {
      setGeneratingCharacteristics(false);
    }
  };

  const handleGenerateMeliDescription = async (forceRegenerate = false) => {
    if (!selectedProductForTool) return;

    setGeneratingMarketplace(true);
    
    try {
      const response = await fetch('/api/generate-description', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          productId: selectedProductForTool.id,
          forceRegenerate
        }),
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const result = await response.json();
      
      if (result.success) {
        setMarketplaceDescription(result.data);
        // Atualizar lista de produtos com descri√ß√£o do Marketplace
        await fetchProductsWithMarketplace();
      } else {
        console.error('Erro ao gerar descri√ß√£o:', result.message);
        alert('Erro ao gerar descri√ß√£o: ' + result.message);
      }
    } catch (error) {
      console.error('Erro ao gerar descri√ß√£o do Marketplace:', error);
      alert('Erro ao gerar descri√ß√£o do Marketplace');
    } finally {
      setGeneratingMarketplace(false);
    }
  };

  const handleSyncAnymarketing = async (product: Product) => {
    // Verificar se o produto tem mapeamento Anymarket
    const anymarketId = anymarketMappings[product.ref_id || ''];
    if (!anymarketId) {
      alert('Este produto n√£o possui ID_ANY vinculado ao Anymarket');
      return;
    }
    
    // Adicionar anymarket_id ao produto para usar no modal
    const productWithAnymarketId = { ...product, anymarket_id: anymarketId };
    setSelectedProductForAnymarket(productWithAnymarketId);
    setShowAnymarketSyncModal(true);
  };

  const handleCropImages = async (product: Product) => {
    console.log('üñºÔ∏è Iniciando busca de imagens para produto:', product.name);
    
    // Verificar se tem anymarket_id direto ou atrav√©s do mapeamento - CACHE FIX
    const anymarketId = product.anymarket_id || anymarketMappings[product.ref_id || ''];
    
    console.log('üîç Debug - Product:', {
      id: product.id,
      name: product.name,
      ref_id: product.ref_id,
      anymarket_id: product.anymarket_id,
      anymarketMappings: anymarketMappings,
      mappedId: anymarketMappings[product.ref_id || ''],
      finalAnymarketId: anymarketId
    });
    
    if (!anymarketId) {
      console.log('‚ùå Produto sem anymarket_id:', product);
      alert('Este produto n√£o possui ID_ANY vinculado ao Anymarket');
      return;
    }
    
    console.log('‚úÖ anymarket_id encontrado:', anymarketId);

    // Registrar log de in√≠cio do processo de crop
    try {
      await fetch('/api/crop-logs', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          productId: product.id,
          anymarketId: anymarketId,
          productName: product.name,
          status: 'processing'
        })
      });
    } catch (logError) {
      console.warn('‚ö†Ô∏è Erro ao registrar log de crop:', logError);
    }

    try {
      // console.log(`üîç Buscando imagens do produto ${anymarketId} no Anymarket...`);
      
      const response = await fetch(`https://api.anymarket.com.br/v2/products/${anymarketId}/images`, {
        method: 'GET',
        headers: {
          'gumgaToken': process.env.NEXT_PUBLIC_ANYMARKET || '',
          'Content-Type': 'application/json',
          'User-Agent': 'Meli-Integration/1.0',
          'Accept': 'application/json'
        },
        cache: 'no-store'
      });

      // console.log('üì° Resposta recebida da API Anymarket:', {
      //   status: response.status,
      //   statusText: response.statusText,
      //   ok: response.ok
      // });

      let originalImages = [];
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error('‚ùå Erro na API do Anymarket:', response.status, errorText);
        console.warn('‚ö†Ô∏è Continuando sem imagens do Anymarket, abrindo modal com imagens da VTEX');
        // N√£o retornar, continuar com lista vazia de imagens originais
        originalImages = [];
      } else {
        const imagesData = await response.json();
        // console.log('üì∏ Dados das imagens recebidos:', imagesData);

        // Filtrar apenas imagens com originalImage
        originalImages = imagesData
          .filter((img: any) => img.originalImage)
          .map((img: any, index: number) => ({
            id: img.id,
            variation: img.variation || 'default',
            originalImage: img.originalImage,
            isMain: img.isMain || img.main || false,
            index: img.index || index + 1
          }));
      }

      // Abrir modal sempre, mesmo sem imagens
      setCropModalData({
        product: {
          id: product.id,
          name: product.name,
          anymarket_id: anymarketId
        },
        originalImages
      });
      console.log('üéØ Abrindo modal de crop com dados:', {
        product: { id: product.id, name: product.name, anymarket_id: anymarketId },
        originalImages: originalImages.length
      });
      setShowCropModal(true);
      
      if (originalImages.length === 0) {
        // console.log(`üì∑ Nenhuma imagem original encontrada para o produto "${product.name}" (ID: ${product.anymarket_id})`);
      }

    } catch (error: any) {
      console.error('‚ùå Erro ao buscar imagens:', error);
      console.warn('‚ö†Ô∏è Continuando com modal mesmo com erro, usando imagens da VTEX');
      
      // Abrir modal mesmo com erro, com lista vazia de imagens originais
      setCropModalData({
        product: {
          id: product.id,
          name: product.name,
          anymarket_id: anymarketId
        },
        originalImages: []
      });
      console.log('üéØ Abrindo modal de crop com erro, dados:', {
        product: { id: product.id, name: product.name, anymarket_id: anymarketId },
        originalImages: 0
      });
      setShowCropModal(true);
    }
  };

  const handleCropProcessingComplete = async (productId: number) => {
    console.log('‚úÖ Processamento de crop conclu√≠do para produto ID:', productId);
    console.log('üîç Estado atual productsWithCroppedImages:', productsWithCroppedImages);
    
    // Atualizar estado visual imediatamente
    setProductsWithCroppedImages(prev => {
      console.log('üîÑ Estado anterior:', prev);
      if (!prev.includes(productId)) {
        const newState = [...prev, productId];
        console.log('‚úÖ Adicionando produto ao estado:', newState);
        return newState;
      }
      console.log('‚ö†Ô∏è Produto j√° est√° no estado');
      return prev;
    });

    // Recarregar dados do banco para garantir consist√™ncia
    try {
      console.log('üîÑ Recarregando dados de crop do banco...');
      await fetchProductsWithCroppedImages();
    } catch (error) {
      console.error('‚ùå Erro ao recarregar dados de crop:', error);
    }
  };

  const handleViewSkus = () => {
    if (selectedProducts.length === 0) {
      alert('Selecione pelo menos um produto para visualizar os SKUs');
      return;
    }
    // Buscar o id do primeiro produto selecionado
    const firstProduct = products.find(p => p.id === selectedProducts[0]);
    if (firstProduct) {
      setSelectedProductId(firstProduct.id);
      setShowSkusModal(true);
    }
  };

  // Estados para processamento em lote
  const [batchCropProgress, setBatchCropProgress] = useState({
    current: 0,
    total: 0,
    currentProduct: '',
    isRunning: false
  });

  // Estado para processamento "All" (todos os processamentos em sequ√™ncia)
  const [batchAllProgress, setBatchAllProgress] = useState({
    current: 0,
    total: 0,
    currentProduct: '',
    currentStep: '',
    isRunning: false,
    completedSteps: {
      analysis: 0,
      marketplace: 0,
      characteristics: 0,
      anymarket: 0,
      crop: 0
    }
  });

  const handleBatchCropImages = async () => {
    console.log('üöÄ Iniciando crop em lote...');
    console.log('üìä Produtos selecionados:', selectedProducts);
    console.log('üìä Total de produtos:', products.length);
    console.log('üìä Produtos j√° processados:', productsWithCroppedImages);

    if (selectedProducts.length === 0) {
      alert('Selecione pelo menos um produto para processar');
      return;
    }

    const productsToProcess = products.filter(p => 
      selectedProducts.includes(p.id) && 
      !productsWithCroppedImages.includes(p.id)
    );

    console.log('üìä Produtos filtrados para processamento:', productsToProcess.map(p => ({
      id: p.id,
      name: p.name,
      anymarket_id: p.anymarket_id,
      alreadyProcessed: productsWithCroppedImages.includes(p.id)
    })));

    if (productsToProcess.length === 0) {
      alert('Nenhum produto v√°lido selecionado para processamento');
      return;
    }

    if (!confirm(`Deseja processar crop de imagens para ${productsToProcess.length} produtos selecionados?`)) {
      return;
    }

    setBatchCropProgress({
      current: 0,
      total: productsToProcess.length,
      currentProduct: '',
      isRunning: true
    });

    let successCount = 0;
    let errorCount = 0;
    const errors: string[] = [];

    for (let i = 0; i < productsToProcess.length; i++) {
      const product = productsToProcess[i];
      
      setBatchCropProgress(prev => ({
        ...prev,
        current: i + 1,
        currentProduct: product.name
      }));

      try {
        console.log(`üîÑ Processando crop para produto ${i + 1}/${productsToProcess.length}: ${product.name}`);
        console.log(`üìã Dados do produto:`, {
          id: product.id,
          name: product.name,
          anymarket_id: product.anymarket_id
        });
        
        // Chamar API de teste primeiro
        console.log(`üì° Chamando API de teste /api/test-batch-crop...`);
        const response = await fetch('/api/test-batch-crop', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            productId: product.id,
            anymarketId: product.anymarket_id
          })
        });

        console.log(`üì° Resposta da API:`, {
          status: response.status,
          statusText: response.statusText,
          ok: response.ok
        });

        const result = await response.json();
        console.log(`üìä Resultado da API:`, result);

        if (result.success) {
          setProductsWithCroppedImages(prev => {
            if (!prev.includes(product.id)) {
              console.log(`‚úÖ Adicionando produto ${product.id} √† lista de processados`);
              return [...prev, product.id];
            }
            return prev;
          });
          
          successCount++;
          console.log(`‚úÖ Crop conclu√≠do para: ${product.name} - ${result.data?.processed || 0} imagens processadas`);
        } else {
          errorCount++;
          const errorMsg = `${product.name}: ${result.message}`;
          errors.push(errorMsg);
          console.error(`‚ùå Erro no crop de ${product.name}:`, result.message);
        }
        
      } catch (error: any) {
        errorCount++;
        const errorMsg = `${product.name}: ${error.message}`;
        errors.push(errorMsg);
        console.error(`‚ùå Erro no crop de ${product.name}:`, error);
        console.error(`‚ùå Stack trace:`, error.stack);
      }
    }

    setBatchCropProgress({
      current: 0,
      total: 0,
      currentProduct: '',
      isRunning: false
    });

    // Mostrar resultado detalhado
    let resultMessage = `Processamento em lote conclu√≠do!\n‚úÖ Sucessos: ${successCount}\n‚ùå Erros: ${errorCount}`;
    
    if (errors.length > 0) {
      resultMessage += `\n\nErros encontrados:\n${errors.slice(0, 5).join('\n')}`;
      if (errors.length > 5) {
        resultMessage += `\n... e mais ${errors.length - 5} erro(s)`;
      }
    }
    
    alert(resultMessage);
  };

  // Fun√ß√£o para processar "All" - todos os processamentos em sequ√™ncia
  const handleBatchAll = async () => {
    console.log('üöÄ Iniciando processamento "All" em lote...');
    console.log('üìä Produtos selecionados:', selectedProducts);

    if (selectedProducts.length === 0) {
      alert('Selecione pelo menos um produto para processar');
      return;
    }

    const productsToProcess = products.filter(p => 
      selectedProducts.includes(p.id)
    );

    if (productsToProcess.length === 0) {
      alert('Nenhum produto v√°lido selecionado para processamento');
      return;
    }

    if (!confirm(`Deseja processar TODOS os passos para ${productsToProcess.length} produtos selecionados?\n\nüì∏ An√°lise de Imagens\nüìù Marketplace\nüìã Caracter√≠sticas\nüîÑ Sincroniza√ß√£o Anymarket\n‚úÇÔ∏è Crop de Imagens`)) {
      return;
    }

    setBatchAllProgress({
      current: 0,
      total: productsToProcess.length * 5, // 5 passos por produto
      currentProduct: '',
      currentStep: '',
      isRunning: true,
      completedSteps: {
        analysis: 0,
        marketplace: 0,
        characteristics: 0,
        anymarket: 0,
        crop: 0
      }
    });

    let totalSuccess = 0;
    let totalErrors = 0;
    const stepResults = {
      analysis: { success: 0, errors: 0 },
      marketplace: { success: 0, errors: 0 },
      characteristics: { success: 0, errors: 0 },
      anymarket: { success: 0, errors: 0 },
      crop: { success: 0, errors: 0 }
    };

    try {
      // PROCESSAR PRODUTO POR PRODUTO (TODAS AS OTIMIZA√á√ïES)
      console.log('üîÑ === PROCESSAMENTO PRODUTO POR PRODUTO ===');
      
      for (let i = 0; i < productsToProcess.length; i++) {
        const product = productsToProcess[i];
        const productIndex = i + 1;
        
        console.log(`\nüéØ === PRODUTO ${productIndex}/${productsToProcess.length}: ${product.name} ===`);
        
        setBatchAllProgress(prev => ({
          ...prev,
          current: i * 5,
          currentProduct: product.name,
          currentStep: `Produto ${productIndex}/${productsToProcess.length}`
        }));

        // 1. AN√ÅLISE DE IMAGENS
        console.log(`üì∏ ETAPA 1/5: An√°lise de Imagens - ${product.name}`);
        setBatchAllProgress(prev => ({ ...prev, currentStep: `An√°lise de Imagens - ${product.name}` }));
        
        try {
          const analysisResponse = await fetch('/api/analyze-images', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              productId: product.id,
              timestamp: Date.now(),
              forceNewAnalysis: true,
              categoryVtexId: product.category_vtex_id
            }),
          });

          if (analysisResponse.ok) {
            const result = await analysisResponse.json();
            if (result.success) {
              setProductsWithAnalysis(prev => {
                if (!prev.includes(product.id)) {
                  return [...prev, product.id];
                }
                return prev;
              });
              stepResults.analysis.success++;
              totalSuccess++;
              console.log(`‚úÖ An√°lise de imagens conclu√≠da para ${product.name}`);
            } else {
              stepResults.analysis.errors++;
              totalErrors++;
              console.log(`‚ùå Erro na an√°lise de imagens para ${product.name}`);
            }
          } else {
            stepResults.analysis.errors++;
            totalErrors++;
            console.log(`‚ùå Erro na an√°lise de imagens para ${product.name}`);
          }
        } catch (error) {
          console.error(`‚ùå Erro na an√°lise de ${product.name}:`, error);
          stepResults.analysis.errors++;
          totalErrors++;
        }

        await new Promise(resolve => setTimeout(resolve, 1000));

        // 2. MARKETPLACE
        console.log(`üìù ETAPA 2/5: Marketplace - ${product.name}`);
        setBatchAllProgress(prev => ({ ...prev, currentStep: `Marketplace - ${product.name}` }));
        
        try {
          const marketplaceResponse = await fetch('/api/generate-description', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              productId: product.id,
              forceRegenerate: false
            })
          });

          if (marketplaceResponse.ok) {
            const result = await marketplaceResponse.json();
            if (result.success) {
              setProductsWithMarketplace(prev => {
                if (!prev.includes(product.id)) {
                  return [...prev, product.id];
                }
                return prev;
              });
              stepResults.marketplace.success++;
              totalSuccess++;
              console.log(`‚úÖ Marketplace conclu√≠do para ${product.name}`);
            } else {
              stepResults.marketplace.errors++;
              totalErrors++;
              console.log(`‚ùå Erro no Marketplace para ${product.name}`);
            }
          } else {
            stepResults.marketplace.errors++;
            totalErrors++;
            console.log(`‚ùå Erro no Marketplace para ${product.name}`);
          }
        } catch (error) {
          console.error(`‚ùå Erro no Marketplace de ${product.name}:`, error);
          stepResults.marketplace.errors++;
          totalErrors++;
        }

        await new Promise(resolve => setTimeout(resolve, 1000));

        // 3. CARACTER√çSTICAS
        console.log(`üìã ETAPA 3/5: Caracter√≠sticas - ${product.name}`);
        setBatchAllProgress(prev => ({ ...prev, currentStep: `Caracter√≠sticas - ${product.name}` }));
        
        try {
          const characteristicsResponse = await fetch('/api/generate-characteristics', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              productId: product.id
            })
          });

          if (characteristicsResponse.ok) {
            const result = await characteristicsResponse.json();
            if (result.success) {
              setProductsWithCharacteristics(prev => {
                if (!prev.includes(product.id)) {
                  return [...prev, product.id];
                }
                return prev;
              });
              stepResults.characteristics.success++;
              totalSuccess++;
              console.log(`‚úÖ Caracter√≠sticas conclu√≠das para ${product.name}`);
            } else {
              stepResults.characteristics.errors++;
              totalErrors++;
              console.log(`‚ùå Erro nas caracter√≠sticas para ${product.name}`);
            }
          } else {
            stepResults.characteristics.errors++;
            totalErrors++;
            console.log(`‚ùå Erro nas caracter√≠sticas para ${product.name}`);
          }
        } catch (error) {
          console.error(`‚ùå Erro nas caracter√≠sticas de ${product.name}:`, error);
          stepResults.characteristics.errors++;
          totalErrors++;
        }

        await new Promise(resolve => setTimeout(resolve, 1000));

        // 4. ANYMARKET (sincroniza√ß√£o individual)
        console.log(`üîÑ ETAPA 4/5: Anymarket - ${product.name}`);
        setBatchAllProgress(prev => ({ ...prev, currentStep: `Anymarket - ${product.name}` }));
        
        try {
          const anymarketResponse = await fetch('/api/anymarket/sync-title', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              productId: product.id
            })
          });

          if (anymarketResponse.ok) {
            const result = await anymarketResponse.json();
            if (result.success) {
              setProductsWithAnymarketSync(prev => {
                if (!prev.includes(product.id)) {
                  return [...prev, product.id];
                }
                return prev;
              });
              stepResults.anymarket.success++;
              totalSuccess++;
              console.log(`‚úÖ Anymarket conclu√≠do para ${product.name}`);
            } else {
              stepResults.anymarket.errors++;
              totalErrors++;
              console.log(`‚ùå Erro no Anymarket para ${product.name}`);
            }
          } else {
            stepResults.anymarket.errors++;
            totalErrors++;
            console.log(`‚ùå Erro no Anymarket para ${product.name}`);
          }
        } catch (error) {
          console.error(`‚ùå Erro no Anymarket de ${product.name}:`, error);
          stepResults.anymarket.errors++;
          totalErrors++;
        }

        await new Promise(resolve => setTimeout(resolve, 1000));

        // 5. CROP DE IMAGENS
        console.log(`‚úÇÔ∏è ETAPA 5/5: Crop de Imagens - ${product.name}`);
        setBatchAllProgress(prev => ({ ...prev, currentStep: `Crop de Imagens - ${product.name}` }));
        
        try {
          // Registrar log de in√≠cio do processo de crop
          try {
            await fetch('/api/crop-logs', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                productId: product.id,
                anymarketId: product.anymarket_id || anymarketMappings[product.ref_id || ''],
                productName: product.name,
                status: 'processing'
              })
            });
          } catch (logError) {
            console.warn('‚ö†Ô∏è Erro ao registrar log de crop:', logError);
          }

          const cropResponse = await fetch('/api/anymarket/crop-images', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              productId: product.id,
              anymarketId: product.anymarket_id || anymarketMappings[product.ref_id || '']
            })
          });

          if (cropResponse.ok) {
            const result = await cropResponse.json();
            if (result.success) {
              setProductsWithCroppedImages(prev => {
                if (!prev.includes(product.id)) {
                  return [...prev, product.id];
                }
                return prev;
              });
              stepResults.crop.success++;
              totalSuccess++;
              console.log(`‚úÖ Crop de imagens conclu√≠do para ${product.name}`);
            } else {
              stepResults.crop.errors++;
              totalErrors++;
              console.log(`‚ùå Erro no crop de imagens para ${product.name}`);
            }
          } else {
            stepResults.crop.errors++;
            totalErrors++;
            console.log(`‚ùå Erro no crop de imagens para ${product.name}`);
          }
        } catch (error) {
          console.error(`‚ùå Erro no crop de imagens de ${product.name}:`, error);
          stepResults.crop.errors++;
          totalErrors++;
        }

        await new Promise(resolve => setTimeout(resolve, 1000));
        
        console.log(`üéâ PRODUTO ${productIndex}/${productsToProcess.length} CONCLU√çDO: ${product.name}`);
        console.log(`üìä Progresso: ${productIndex}/${productsToProcess.length} produtos processados`);
      }

    } catch (error) {
      console.error('‚ùå Erro geral no processamento All:', error);
    } finally {
      setBatchAllProgress({
        current: 0,
        total: 0,
        currentProduct: '',
        currentStep: '',
        isRunning: false,
        completedSteps: {
          analysis: 0,
          marketplace: 0,
          characteristics: 0,
          anymarket: 0,
          crop: 0
        }
      });

      // Mostrar resultado final detalhado
      let resultMessage = `üéâ Processamento "All" conclu√≠do!\n\n`;
      resultMessage += `üìä RESUMO GERAL:\n`;
      resultMessage += `‚úÖ Total de sucessos: ${totalSuccess}\n`;
      resultMessage += `‚ùå Total de erros: ${totalErrors}\n\n`;
      
      resultMessage += `üì∏ AN√ÅLISE DE IMAGENS:\n`;
      resultMessage += `‚úÖ Sucessos: ${stepResults.analysis.success}\n`;
      resultMessage += `‚ùå Erros: ${stepResults.analysis.errors}\n\n`;
      
      resultMessage += `üìù MARKETPLACE:\n`;
      resultMessage += `‚úÖ Sucessos: ${stepResults.marketplace.success}\n`;
      resultMessage += `‚ùå Erros: ${stepResults.marketplace.errors}\n\n`;
      
      resultMessage += `üìã CARACTER√çSTICAS:\n`;
      resultMessage += `‚úÖ Sucessos: ${stepResults.characteristics.success}\n`;
      resultMessage += `‚ùå Erros: ${stepResults.characteristics.errors}\n\n`;
      
      resultMessage += `üîÑ ANYMARKET:\n`;
      resultMessage += `‚úÖ Sucessos: ${stepResults.anymarket.success}\n`;
      resultMessage += `‚ùå Erros: ${stepResults.anymarket.errors}\n\n`;
      
      resultMessage += `‚úÇÔ∏è CROP DE IMAGENS:\n`;
      resultMessage += `‚úÖ Sucessos: ${stepResults.crop.success}\n`;
      resultMessage += `‚ùå Erros: ${stepResults.crop.errors}`;
      
      alert(resultMessage);
      
      // Limpar sele√ß√£o
      setSelectedProducts([]);
    }
  };

  const performAnymarketSync = async () => {
    if (!selectedProductForTool) return;

    try {
      console.log('üîÑ Iniciando sincroniza√ß√£o PUT com Anymarket...');
      
      const response = await fetch('/api/anymarket/sync-put', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          productId: selectedProductForTool.id
        })
      });

      console.log('üì° Resposta recebida:', response.status, response.statusText);

      if (!response.ok) {
        const errorText = await response.text();
        console.error('‚ùå Erro HTTP:', response.status, errorText);
        alert(`‚ùå Erro HTTP ${response.status}: ${errorText}`);
        return;
      }

      const result = await response.json();
      console.log('üìä Resultado da sincroniza√ß√£o:', result);
      
      if (result.success) {
        alert(`‚úÖ Produto sincronizado com sucesso!\n\nT√≠tulo: ${result.data.title}\nID_ANY: ${result.data.anymarket_id}`);
        console.log('‚úÖ Sincroniza√ß√£o realizada:', result.data);
        
        // Adicionar produto √† lista de sincronizados
        setProductsWithAnymarketSync(prev => [...prev, selectedProductForTool.id]);
        
      } else {
        console.error('‚ùå Erro na sincroniza√ß√£o:', result.message);
        alert('‚ùå Erro na sincroniza√ß√£o: ' + result.message);
      }
    } catch (error) {
      console.error('‚ùå Erro ao sincronizar com Anymarket:', error);
      alert('‚ùå Erro de conex√£o ao sincronizar com Anymarket: ' + (error as Error).message);
    }
  };



  const handleGenerateAnalysis = async () => {
    if (!selectedProductForAnalysis) {
      console.log('‚ùå Nenhum produto selecionado para an√°lise');
      return;
    }

    console.log('üîÑ Iniciando an√°lise para produto:', selectedProductForAnalysis.name, 'ID:', selectedProductForAnalysis.id);

    try {
      setAnalyzingSingleImage(true);
      setAnalysisError(null);
      
      // Fechar modais
      setShowAnalysisSelectionModal(false);
      setShowImageAnalysisModal(false);
      
      // Adicionar timestamp para evitar cache
      const timestamp = Date.now();
      
      console.log('üì° Enviando requisi√ß√£o para API...');
      const response = await fetch('/api/analyze-images', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
          productId: selectedProductForAnalysis.id,
          timestamp: timestamp,
          forceNewAnalysis: true,
          categoryVtexId: selectedProductForAnalysis.category_vtex_id
        }),
      });

      console.log('üì° Resposta recebida, status:', response.status);
      const result = await response.json();

      if (result.success) {
        console.log('‚úÖ An√°lise conclu√≠da para:', selectedProductForAnalysis.name);
        
        // Atualizar lista de produtos com an√°lise
        if (selectedProductForAnalysis) {
          setProductsWithAnalysis(prev => Array.from(new Set([...prev, selectedProductForAnalysis.id])));
        }
        
        // Mostrar mensagem de sucesso
        alert(`An√°lise conclu√≠da com sucesso para: ${selectedProductForAnalysis.name}`);
      } else {
        console.log('‚ùå Erro na an√°lise:', result.message);
        alert(`Erro na an√°lise: ${result.message || 'Erro ao analisar imagens'}`);
      }
    } catch (error) {
      console.error('‚ùå Erro ao analisar imagens:', error);
      alert(`Erro de conex√£o: ${(error as Error).message}`);
    } finally {
      setAnalyzingSingleImage(false);
    }
  };
  
  return (
    <Layout title="Produtos" subtitle="Gerencie os produtos importados da VTEX">


      {/* A√ß√µes em Lote */}
      {selectedProducts.length > 0 && (
        <Card className="mb-6 relative z-[90] border-2 border-primary/20">
          <CardHeader className="pb-3">
            <div className="flex items-center justify-between">
              <div className="flex items-center space-x-3">
                <div className="w-8 h-8 bg-primary/10 rounded-lg flex items-center justify-center">
                  <Package className="w-4 h-4 text-primary" />
                </div>
                <div>
                  <CardTitle className="text-lg">
                    {selectedProducts.length} produto(s) selecionado(s)
                  </CardTitle>
                  <p className="text-sm text-muted-foreground">
                    Execute a√ß√µes em lote nos produtos selecionados
                  </p>
                </div>
              </div>
              <Button
                variant="outline"
                size="sm"
                onClick={() => setSelectedProducts([])}
                className="text-gray-600 hover:text-gray-800"
              >
                <X className="w-4 h-4 mr-2" />
                Limpar Sele√ß√£o
              </Button>
            </div>
          </CardHeader>
          <CardContent>
            <div className="flex-1">
              
              {/* Barra de Progresso - An√°lise de Imagens */}
              {batchAnalysisProgress.isRunning && (
                <div className="w-full relative z-[95] mb-4">
                  <div className="flex items-center justify-between text-sm mb-2">
                    <div className="flex items-center space-x-2">
                      <Camera className="w-4 h-4 text-blue-600" />
                      <span className="font-medium">Analisando Imagens</span>
                    </div>
                    <Badge variant="outline" className="text-xs">
                      {batchAnalysisProgress.current}/{batchAnalysisProgress.total}
                    </Badge>
                  </div>
                  <Progress 
                    value={batchAnalysisProgress.total > 0 ? (batchAnalysisProgress.current / batchAnalysisProgress.total) * 100 : 0} 
                    className="h-2 mb-2"
                  />
                  <div className="flex items-center justify-between text-xs text-muted-foreground">
                    <span className="truncate max-w-xs">{batchAnalysisProgress.currentProduct}</span>
                    <span>{Math.round((batchAnalysisProgress.current / batchAnalysisProgress.total) * 100)}% conclu√≠do</span>
                  </div>
                </div>
              )}

              {/* Barra de Progresso - Marketplace */}
              {batchMarketplaceProgress.isRunning && (
                <div className="w-full relative z-[95] mb-4">
                  <div className="flex items-center justify-between text-sm mb-2">
                    <div className="flex items-center space-x-2">
                      <TrendingUp className="w-4 h-4 text-yellow-600" />
                      <span className="font-medium">Gerando Marketplace</span>
                    </div>
                    <Badge variant="outline" className="text-xs">
                      {batchMarketplaceProgress.current}/{batchMarketplaceProgress.total}
                    </Badge>
                  </div>
                  <Progress 
                    value={batchMarketplaceProgress.total > 0 ? (batchMarketplaceProgress.current / batchMarketplaceProgress.total) * 100 : 0} 
                    className="h-2 mb-2"
                  />
                  <div className="flex items-center justify-between text-xs text-muted-foreground">
                    <span className="truncate max-w-xs">{batchMarketplaceProgress.currentProduct}</span>
                    <span>{Math.round((batchMarketplaceProgress.current / batchMarketplaceProgress.total) * 100)}% conclu√≠do</span>
                  </div>
                </div>
              )}

              {/* Barra de Progresso - Caracter√≠sticas */}
              {batchCharacteristicsProgress.isRunning && (
                <div className="w-full relative z-[95] mb-4">
                  <div className="flex items-center justify-between text-sm mb-2">
                    <div className="flex items-center space-x-2">
                      <Settings className="w-4 h-4 text-purple-600" />
                      <span className="font-medium">Gerando Caracter√≠sticas</span>
                    </div>
                    <Badge variant="outline" className="text-xs">
                      {batchCharacteristicsProgress.current}/{batchCharacteristicsProgress.total}
                    </Badge>
                  </div>
                  <Progress 
                    value={batchCharacteristicsProgress.total > 0 ? (batchCharacteristicsProgress.current / batchCharacteristicsProgress.total) * 100 : 0} 
                    className="h-2 mb-2"
                  />
                  <div className="flex items-center justify-between text-xs text-muted-foreground">
                    <span className="truncate max-w-xs">{batchCharacteristicsProgress.currentProduct}</span>
                    <span>{Math.round((batchCharacteristicsProgress.current / batchCharacteristicsProgress.total) * 100)}% conclu√≠do</span>
                  </div>
                </div>
              )}

              {/* Barra de Progresso - Anymarket */}
              {batchAnymarketProgress.isRunning && (
                <div className="w-full relative z-[95] mb-4">
                  <div className="flex items-center justify-between text-sm mb-2">
                    <div className="flex items-center space-x-2">
                      <Activity className="w-4 h-4 text-green-600" />
                      <span className="font-medium">Sincronizando Anymarket</span>
                    </div>
                    <Badge variant="outline" className="text-xs">
                      {batchAnymarketProgress.current}/{batchAnymarketProgress.total}
                    </Badge>
                  </div>
                  <Progress 
                    value={batchAnymarketProgress.total > 0 ? (batchAnymarketProgress.current / batchAnymarketProgress.total) * 100 : 0} 
                    className="h-2 mb-2"
                  />
                  <div className="flex items-center justify-between text-xs text-muted-foreground">
                    <span className="truncate max-w-xs">{batchAnymarketProgress.currentProduct}</span>
                    <span>{Math.round((batchAnymarketProgress.current / batchAnymarketProgress.total) * 100)}% conclu√≠do</span>
                  </div>
                </div>
              )}

              {/* Barra de Progresso - Atualiza√ß√£o de Estoque */}
              {batchStockProgress.isRunning && (
                <div className="w-full relative z-[95] mb-3">
                  <div className="flex items-center justify-between text-xs text-gray-500 mb-1">
                    <span>Atualizando Estoque: {batchStockProgress.currentProduct}</span>
                    <span>{batchStockProgress.current}/{batchStockProgress.total}</span>
                  </div>
                  <div className="w-full bg-gray-200 rounded-full h-2">
                    <div 
                      className="bg-purple-600 h-2 rounded-full transition-all duration-300 ease-out"
                      style={{ 
                        width: `${batchStockProgress.total > 0 ? (batchStockProgress.current / batchStockProgress.total) * 100 : 0}%` 
                      }}
                    ></div>
                  </div>
                  <div className="text-xs text-gray-500 mt-1">
                    {Math.round((batchStockProgress.current / batchStockProgress.total) * 100)}% conclu√≠do
                  </div>
                </div>
              )}

              {/* Barra de Progresso - Crop de Imagens */}
              {batchCropProgress.isRunning && (
                <div className="w-full relative z-[95] mb-3">
                  <div className="flex items-center justify-between text-xs text-gray-500 mb-1">
                    <span>Processando Crop: {batchCropProgress.currentProduct}</span>
                    <span>{batchCropProgress.current}/{batchCropProgress.total}</span>
                  </div>
                  <div className="w-full bg-gray-200 rounded-full h-2">
                    <div 
                      className="bg-orange-600 h-2 rounded-full transition-all duration-300 ease-out"
                      style={{ 
                        width: `${batchCropProgress.total > 0 ? (batchCropProgress.current / batchCropProgress.total) * 100 : 0}%` 
                      }}
                    ></div>
                  </div>
                  <div className="text-xs text-gray-500 mt-1">
                    {Math.round((batchCropProgress.current / batchCropProgress.total) * 100)}% conclu√≠do
                  </div>
                </div>
              )}

              {/* Barra de Progresso - Processamento "All" */}
              {batchAllProgress.isRunning && (
                <div className="w-full relative z-[95] mb-3">
                  <div className="flex items-center justify-between text-xs text-gray-500 mb-1">
                    <span>Processamento All - {batchAllProgress.currentStep}: {batchAllProgress.currentProduct}</span>
                    <span>{batchAllProgress.current}/{batchAllProgress.total}</span>
                  </div>
                  <div className="w-full bg-gray-200 rounded-full h-3">
                    <div 
                      className="bg-gradient-to-r from-blue-500 via-yellow-500 via-green-500 via-purple-500 to-orange-500 h-3 rounded-full transition-all duration-300 ease-out"
                      style={{ 
                        width: `${batchAllProgress.total > 0 ? (batchAllProgress.current / batchAllProgress.total) * 100 : 0}%` 
                      }}
                    ></div>
                  </div>
                  <div className="text-xs text-gray-500 mt-1">
                    {Math.round((batchAllProgress.current / batchAllProgress.total) * 100)}% conclu√≠do
                  </div>
                  <div className="text-xs text-gray-400 mt-1">
                    üì∏ An√°lise ‚Üí üìù Marketplace ‚Üí üîÑ Anymarket ‚Üí üì¶ Estoque ‚Üí ‚úÇÔ∏è Crop
                  </div>
                </div>
              )}
            </div>
            
            <div className="flex flex-wrap gap-1 ml-4">
              <button
                onClick={handleAnalyzeSelectedImages}
                disabled={batchAnalysisProgress.isRunning || batchMarketplaceProgress.isRunning || batchAnymarketProgress.isRunning || batchStockProgress.isRunning || batchCropProgress.isRunning || batchAllProgress.isRunning || batchCharacteristicsProgress.isRunning}
                className="px-2 py-1 text-xs text-blue-600 border border-blue-300 rounded hover:bg-blue-50 transition-colors flex items-center disabled:opacity-50 disabled:cursor-not-allowed"
                title="Analisar Imagens"
              >
                {batchAnalysisProgress.isRunning ? (
                  <Loader2 className="h-3 w-3 mr-1 animate-spin" />
                ) : (
                  <Camera className="h-3 w-3 mr-1" />
                )}
                {batchAnalysisProgress.isRunning ? 'Analisando...' : 'An√°lise'}
              </button>
              <button
                onClick={handleGenerateMeliBatch}
                disabled={batchMarketplaceProgress.isRunning || batchAnalysisProgress.isRunning || batchAnymarketProgress.isRunning || batchStockProgress.isRunning || batchCropProgress.isRunning || batchAllProgress.isRunning || batchCharacteristicsProgress.isRunning}
                className="px-2 py-1 text-xs text-yellow-600 border border-yellow-300 rounded hover:bg-yellow-50 transition-colors flex items-center disabled:opacity-50 disabled:cursor-not-allowed"
                title="Gerar Marketplace"
              >
                {batchMarketplaceProgress.isRunning ? (
                  <Loader2 className="h-3 w-3 mr-1 animate-spin" />
                ) : (
                  <span className="h-3 w-3 mr-1 flex items-center justify-center font-bold text-xs">M</span>
                )}
                {batchMarketplaceProgress.isRunning ? 'Gerando...' : 'Marketplace'}
              </button>
              <button
                onClick={handleGenerateCharacteristicsBatch}
                disabled={batchCharacteristicsProgress.isRunning || batchAnalysisProgress.isRunning || batchMarketplaceProgress.isRunning || batchAnymarketProgress.isRunning || batchStockProgress.isRunning || batchCropProgress.isRunning || batchAllProgress.isRunning}
                className="px-2 py-1 text-xs text-purple-600 border border-purple-300 rounded hover:bg-purple-50 transition-colors flex items-center disabled:opacity-50 disabled:cursor-not-allowed"
                title="Gerar Caracter√≠sticas"
              >
                {batchCharacteristicsProgress.isRunning ? (
                  <Loader2 className="h-3 w-3 mr-1 animate-spin" />
                ) : (
                  <span className="h-3 w-3 mr-1 flex items-center justify-center font-bold text-xs">C</span>
                )}
                {batchCharacteristicsProgress.isRunning ? 'Gerando...' : 'Caracter√≠sticas'}
              </button>
              <button
                onClick={handleAnymarketSyncBatch}
                disabled={batchAnymarketProgress.isRunning || batchAnalysisProgress.isRunning || batchMarketplaceProgress.isRunning || batchStockProgress.isRunning || batchCropProgress.isRunning || batchAllProgress.isRunning || batchCharacteristicsProgress.isRunning}
                className="px-2 py-1 text-xs text-green-600 border border-green-300 rounded hover:bg-green-50 transition-colors flex items-center disabled:opacity-50 disabled:cursor-not-allowed"
                title="Sincronizar Anymarket"
              >
                {batchAnymarketProgress.isRunning ? (
                  <Loader2 className="h-3 w-3 mr-1 animate-spin" />
                ) : (
                  <span className="h-3 w-3 mr-1 flex items-center justify-center font-bold text-xs">A</span>
                )}
                {batchAnymarketProgress.isRunning ? 'Sincronizando...' : 'Anymarket'}
              </button>
              <button
                onClick={handleUpdateStockBatch}
                disabled={batchStockProgress.isRunning || batchAnalysisProgress.isRunning || batchMarketplaceProgress.isRunning || batchAnymarketProgress.isRunning || batchCropProgress.isRunning || batchAllProgress.isRunning}
                className="px-2 py-1 text-xs text-purple-600 border border-purple-300 rounded hover:bg-purple-50 transition-colors flex items-center disabled:opacity-50 disabled:cursor-not-allowed"
                title="Atualizar Estoque"
              >
                {batchStockProgress.isRunning ? (
                  <Loader2 className="h-3 w-3 mr-1 animate-spin" />
                ) : (
                  <Warehouse className="h-3 w-3 mr-1" />
                )}
                {batchStockProgress.isRunning ? 'Atualizando...' : 'Estoque'}
              </button>
              <button
                onClick={handleBatchCropImages}
                disabled={batchCropProgress.isRunning || batchAnalysisProgress.isRunning || batchMarketplaceProgress.isRunning || batchAnymarketProgress.isRunning || batchStockProgress.isRunning || batchAllProgress.isRunning}
                className="px-2 py-1 text-xs text-orange-600 border border-orange-300 rounded hover:bg-orange-50 transition-colors flex items-center disabled:opacity-50 disabled:cursor-not-allowed"
                title="Crop de Imagens"
              >
                {batchCropProgress.isRunning ? (
                  <Loader2 className="h-3 w-3 mr-1 animate-spin" />
                ) : (
                  <Crop className="h-3 w-3 mr-1" />
                )}
                {batchCropProgress.isRunning ? 'Processando...' : 'Crop'}
              </button>
              <button
                onClick={handleBatchAll}
                disabled={batchAllProgress.isRunning || batchAnalysisProgress.isRunning || batchMarketplaceProgress.isRunning || batchAnymarketProgress.isRunning || batchStockProgress.isRunning || batchCropProgress.isRunning}
                className="px-2 py-1 text-xs text-indigo-600 border border-indigo-300 rounded hover:bg-indigo-50 transition-colors flex items-center disabled:opacity-50 disabled:cursor-not-allowed font-bold"
                title="Processar Todas as A√ß√µes"
              >
                {batchAllProgress.isRunning ? (
                  <Loader2 className="h-3 w-3 mr-1 animate-spin" />
                ) : (
                  <span className="h-3 w-3 mr-1 flex items-center justify-center font-bold text-xs">T</span>
                )}
                {batchAllProgress.isRunning ? 'Processando...' : 'Todas'}
              </button>
              <button
                onClick={handleExportSelected}
                disabled={isExporting || batchStockProgress.isRunning || batchAnalysisProgress.isRunning || batchMarketplaceProgress.isRunning || batchAnymarketProgress.isRunning || batchCropProgress.isRunning || batchAllProgress.isRunning}
                className="px-2 py-1 text-xs text-indigo-600 border border-indigo-300 rounded hover:bg-indigo-50 transition-colors flex items-center disabled:opacity-50 disabled:cursor-not-allowed"
                title="Exportar XLSX"
              >
                {isExporting ? (
                  <Loader2 className="h-3 w-3 mr-1 animate-spin" />
                ) : (
                  <Download className="h-3 w-3 mr-1" />
                )}
                {isExporting ? 'Exportando...' : 'Exportar'}
              </button>
              <button
                onClick={handleViewSkus}
                disabled={selectedProducts.length === 0}
                className="px-2 py-1 text-xs text-cyan-600 border border-cyan-300 rounded hover:bg-cyan-50 transition-colors flex items-center disabled:opacity-50 disabled:cursor-not-allowed"
                title="Visualizar SKUs"
              >
                <Package className="h-3 w-3 mr-1" />
                SKUs
              </button>
              <button
                onClick={handleDeleteSelected}
                disabled={isExporting || batchAnalysisProgress.isRunning || batchMarketplaceProgress.isRunning || batchAnymarketProgress.isRunning || batchStockProgress.isRunning}
                className="px-2 py-1 text-xs text-red-600 border border-red-300 rounded hover:bg-red-50 transition-colors flex items-center disabled:opacity-50 disabled:cursor-not-allowed"
                title="Excluir Selecionados"
              >
                <Trash2 className="h-3 w-3" />
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Campo de Busca e Controles */}
      <Card className="mb-6">
        <CardHeader>
          <div className="flex items-center justify-between">
            <div className="flex items-center space-x-3">
              <div className="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                <Filter className="w-4 h-4 text-blue-600" />
              </div>
              <div>
                <CardTitle>Filtros e Busca</CardTitle>
                <p className="text-sm text-muted-foreground">
                  Encontre produtos espec√≠ficos usando os filtros abaixo
                </p>
              </div>
            </div>
            <Button
              variant="outline"
              onClick={() => clearFilters()}
              className="text-gray-600 hover:text-gray-800"
            >
              <RefreshCw className="w-4 h-4 mr-2" />
              Limpar Filtros
            </Button>
          </div>
        </CardHeader>
        <CardContent>

          {/* Campo de Busca */}
          <div className="mb-6">
            <label htmlFor="search" className="block text-sm font-medium mb-2">
              Buscar Produtos
            </label>
            <div className="relative">
              <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground" />
              <Input
                type="text"
                id="search"
                placeholder="Digite o nome do produto, ref_id, marca ou categoria..."
                value={filters.search || ''}
                onChange={(e) => {
                  updateFilters({ search: e.target.value });
                }}
                className="pl-10"
              />
            </div>
          </div>
        
          {/* Filtros */}
          <div className="bg-muted/50 p-4 rounded-lg">
            <div className="flex items-center space-x-2 mb-4">
              <Settings className="w-4 h-4 text-muted-foreground" />
              <h3 className="font-medium">Filtros Avan√ßados</h3>
            </div>
            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4">
            {/* Marca */}
            <div>
              <label className="block text-xs font-medium text-gray-700 mb-1">
                Marca
              </label>
              <Combobox
                options={brands.map(brand => ({
                  value: brand.id,
                  label: brand.name
                }))}
                value={Array.isArray(filters.brand_id) ? filters.brand_id : []}
                onValueChange={(selectedValues) => {
                  updateFilters({ brand_id: selectedValues });
                }}
                placeholder={loadingBrands ? "Carregando..." : "Selecionar marcas"}
                searchPlaceholder="Buscar marcas..."
                emptyText="Nenhuma marca encontrada."
                className="w-full"
              />
            </div>
            
            {/* Categoria */}
            <div>
              <label className="block text-xs font-medium text-gray-700 mb-1">
                Categoria
              </label>
              <Combobox
                options={categories.map(category => ({
                  value: category.id,
                  label: category.name
                }))}
                value={Array.isArray(filters.category_id) ? filters.category_id : []}
                onValueChange={(selectedValues) => {
                  updateFilters({ category_id: selectedValues });
                }}
                placeholder={loadingCategories ? "Carregando..." : "Selecionar categorias"}
                searchPlaceholder="Buscar categorias..."
                emptyText="Nenhuma categoria encontrada."
                className="w-full"
              />
            </div>
            {/* An√°lise de Imagens */}
            <div>
              <label className="block text-xs font-medium text-gray-700 mb-1">
                An√°lise de Imagens
              </label>
              <Select
                value={filters.has_image_analysis === true ? 'true' : filters.has_image_analysis === false ? 'false' : 'all'}
                onValueChange={(value) => {
                  if (value === 'all') {
                    updateFilters({ has_image_analysis: undefined });
                  } else if (value === 'true') {
                    updateFilters({ has_image_analysis: true });
                  } else {
                    updateFilters({ has_image_analysis: false });
                  }
                }}
              >
                <SelectTrigger className="w-full">
                  <SelectValue placeholder="Selecionar an√°lise" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">Todas as an√°lises</SelectItem>
                  <SelectItem value="true">üñºÔ∏è Com An√°lise</SelectItem>
                  <SelectItem value="false">üö´ Sem An√°lise</SelectItem>
                </SelectContent>
              </Select>
            </div>

            {/* Crop de Imagens */}
            <div>
              <label className="block text-xs font-medium text-gray-700 mb-1">
                Crop de Imagens
              </label>
              <Select
                value={filters.has_crop_processed === true ? 'true' : filters.has_crop_processed === false ? 'false' : 'all'}
                onValueChange={(value) => {
                  if (value === 'all') {
                    updateFilters({ has_crop_processed: undefined });
                  } else if (value === 'true') {
                    updateFilters({ has_crop_processed: true });
                  } else {
                    updateFilters({ has_crop_processed: false });
                  }
                }}
              >
                <SelectTrigger className="w-full">
                  <SelectValue placeholder="Selecionar crop" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">Todos os crops</SelectItem>
                  <SelectItem value="true">‚úÇÔ∏è Com Crop</SelectItem>
                  <SelectItem value="false">üö´ Sem Crop</SelectItem>
                </SelectContent>
              </Select>
            </div>

            {/* Status de Otimiza√ß√µes */}
            <div>
              <label className="block text-xs font-medium text-gray-700 mb-1">
                Status de Otimiza√ß√µes
              </label>
              <Select
                value={filters.optimization_status || 'all'}
                onValueChange={(value) => {
                  if (value === 'all') {
                    updateFilters({ optimization_status: undefined });
                  } else {
                    updateFilters({ optimization_status: value });
                  }
                }}
              >
                <SelectTrigger className="w-full">
                  <SelectValue placeholder="Selecionar status" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">Todos os status</SelectItem>
                  <SelectItem value="none">üö´ Sem Otimiza√ß√µes</SelectItem>
                  <SelectItem value="partial">‚ö†Ô∏è Otimiza√ß√£o Parcial</SelectItem>
                  <SelectItem value="complete">‚úÖ Totalmente Otimizado</SelectItem>
                  <SelectItem value="analysis_only">üñºÔ∏è S√≥ An√°lise</SelectItem>
                  <SelectItem value="marketplace_only">üìù S√≥ Marketplace</SelectItem>
                  <SelectItem value="anymarket_only">üîÑ S√≥ Anymarket</SelectItem>
                </SelectContent>
              </Select>
            </div>
            
            {/* Marketplace */}
            <div>
              <label className="block text-xs font-medium text-gray-700 mb-1">
                Marketplace
              </label>
              <Select
                value={filters.has_marketplace_description === true ? 'true' : filters.has_marketplace_description === false ? 'false' : 'all'}
                onValueChange={(value) => {
                  if (value === 'all') {
                    updateFilters({ has_marketplace_description: undefined });
                  } else if (value === 'true') {
                    updateFilters({ has_marketplace_description: true });
                  } else {
                    updateFilters({ has_marketplace_description: false });
                  }
                }}
              >
                <SelectTrigger className="w-full">
                  <SelectValue placeholder="Selecionar" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">Todos</SelectItem>
                  <SelectItem value="true">üìù Com Descri√ß√£o</SelectItem>
                  <SelectItem value="false">‚ùå Sem Descri√ß√£o</SelectItem>
                </SelectContent>
              </Select>
            </div>
            
            {/* Anymarket */}
            <div>
              <label className="block text-xs font-medium text-gray-700 mb-1">
                Anymarket
              </label>
              <Select
                value={filters.has_anymarket_ref_id === true ? 'true' : filters.has_anymarket_ref_id === false ? 'false' : 'all'}
                onValueChange={(value) => {
                  if (value === 'all') {
                    updateFilters({ has_anymarket_ref_id: undefined });
                  } else if (value === 'true') {
                    updateFilters({ has_anymarket_ref_id: true });
                  } else {
                    updateFilters({ has_anymarket_ref_id: false });
                  }
                }}
              >
                <SelectTrigger className="w-full">
                  <SelectValue placeholder="Selecionar" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">Todos</SelectItem>
                  <SelectItem value="true">üîÑ Com Refer√™ncia</SelectItem>
                  <SelectItem value="false">‚ùå Sem Refer√™ncia</SelectItem>
                </SelectContent>
              </Select>
            </div>
            
            {/* Sincroniza√ß√£o */}
            <div>
              <label className="block text-xs font-medium text-gray-700 mb-1">
                Sincroniza√ß√£o
              </label>
              <Select
                value={filters.has_anymarket_sync_log === true ? 'true' : filters.has_anymarket_sync_log === false ? 'false' : 'all'}
                onValueChange={(value) => {
                  if (value === 'all') {
                    updateFilters({ has_anymarket_sync_log: undefined });
                  } else if (value === 'true') {
                    updateFilters({ has_anymarket_sync_log: true });
                  } else {
                    updateFilters({ has_anymarket_sync_log: false });
                  }
                }}
              >
                <SelectTrigger className="w-full">
                  <SelectValue placeholder="Selecionar" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">Todos</SelectItem>
                  <SelectItem value="true">‚ö° Com Log</SelectItem>
                  <SelectItem value="false">‚ùå Sem Log</SelectItem>
                </SelectContent>
              </Select>
            </div>

            {/* Filtro de Estoque */}
            <div>
              <label className="block text-xs font-medium text-gray-700 mb-1">
                Estoque
              </label>
              <div className="flex space-x-2">
                <Select
                  value={filters.stock_operator || ''}
                  onValueChange={(value) => {
                    updateFilters({ 
                      stock_operator: value || undefined,
                      stock_value: value ? filters.stock_value : undefined
                    });
                  }}
                >
                  <SelectTrigger className="w-20">
                    <SelectValue placeholder="Op" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value=">">&gt;</SelectItem>
                    <SelectItem value=">=">&gt;=</SelectItem>
                    <SelectItem value="=">=</SelectItem>
                    <SelectItem value="<">&lt;</SelectItem>
                    <SelectItem value="<=">&lt;=</SelectItem>
                    <SelectItem value="!=">!=</SelectItem>
                  </SelectContent>
                </Select>
                <input
                  type="number"
                  min="0"
                  placeholder="0"
                  value={filters.stock_value || ''}
                  onChange={(e) => {
                    const value = e.target.value ? parseInt(e.target.value) : undefined;
                    updateFilters({ stock_value: value });
                  }}
                  className="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary-500 focus:border-primary-500"
                />
              </div>
            </div>
          </div>
        </CardContent>
      </Card>


      {/* Tabela de Produtos */}
      <Card className={isExporting || batchAnalysisProgress.isRunning || batchMarketplaceProgress.isRunning || batchAnymarketProgress.isRunning || batchStockProgress.isRunning || batchCharacteristicsProgress.isRunning ? 'pointer-events-none opacity-75' : ''}>
        <CardHeader>
          <div className="flex items-center justify-between">
            <div className="flex items-center space-x-3">
              <div className="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                <BarChart3 className="w-4 h-4 text-green-600" />
              </div>
              <div>
                <CardTitle>Produtos</CardTitle>
                <p className="text-sm text-muted-foreground">
                  {totalProducts} produtos encontrados
                </p>
              </div>
            </div>
            <div className="flex items-center space-x-2">
              <Badge variant="outline" className="text-xs">
                P√°gina {currentPage} de {totalPages}
              </Badge>
              <Badge variant="secondary" className="text-xs">
                {itemsPerPage} por p√°gina
              </Badge>
            </div>
          </div>
        </CardHeader>
        <CardContent className="p-0">
          <ProductTable
          products={products}
          loading={loading}
          currentPage={currentPage}
          totalPages={totalPages}
          totalProducts={totalProducts}
          itemsPerPage={itemsPerPage}
          sort={sort}
          selectedProducts={selectedProducts}
          onSort={updateSort}
          onPageChange={updatePage}
          onItemsPerPageChange={updateItemsPerPage}
          onProductSelect={handleSelectProduct}
          onSelectAll={handleSelectAll}
          onViewProduct={handleViewProduct}
          onDeleteProduct={handleDeleteProduct}
          onAnalyzeImages={handleAnalyzeImages}
          onGenerateTitle={handleGenerateTitle}
          onGenerateMarketplaceDescription={handleGenerateMarketplaceDescription}
          onGenerateCharacteristics={handleGenerateCharacteristics}
          onSyncAnymarketing={handleSyncAnymarketing}
          onCropImages={handleCropImages}
          productsWithAnalysis={productsWithAnalysis}
          productsWithTitle={productsWithTitle}
          productsWithMarketplace={productsWithMarketplace}
          productsWithCharacteristics={productsWithCharacteristics}
          productsWithAnymarketSync={productsWithAnymarketSync}
          productsWithCroppedImages={productsWithCroppedImages}
          anymarketMappings={anymarketMappings}
          />
        </CardContent>
      </Card>

      {/* Modal de Detalhes do Produto */}
      {/* {console.log('üîç Estado do modal - showModal:', showModal, 'selectedProduct:', selectedProduct?.name)} */}
      {showModal && selectedProduct && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
            {/* Header do Modal */}
            <div className="flex items-center justify-between p-6 border-b border-gray-100">
              <div className="flex items-center space-x-4">
                <div className="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center shadow-lg">
                  <Package className="h-6 w-6 text-white" />
                </div>
                <div>
                  <h2 className="text-xl font-bold text-gray-900">{selectedProduct.name}</h2>
                  <p className="text-gray-600">RefId: {selectedProduct.ref_id || 'N/A'}</p>
                </div>
              </div>
              <button
                onClick={closeModal}
                className="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors"
              >
                <X className="h-5 w-5" />
              </button>
            </div>

            {/* Conte√∫do do Modal */}
            <div className="p-6 overflow-y-auto max-h-[calc(90vh-140px)]">
              {modalLoading ? (
                <div className="flex items-center justify-center py-12">
                  <div className="w-8 h-8 border-4 border-primary-600 border-t-transparent rounded-full animate-spin"></div>
                  <span className="ml-3 text-gray-600">Carregando detalhes...</span>
                </div>
              ) : (
                <div className="space-y-6">
                  {/* Informa√ß√µes B√°sicas */}
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                      <h3 className="text-lg font-semibold text-gray-900 mb-3">Informa√ß√µes B√°sicas</h3>
                      <div className="space-y-2">
                        <div>
                          <span className="text-sm font-medium text-gray-500">Nome:</span>
                          <p className="text-gray-900">{selectedProduct.name}</p>
                        </div>
                        <div>
                          <span className="text-sm font-medium text-gray-500">RefId:</span>
                          <p className="text-gray-900 font-mono">{selectedProduct.ref_id || 'N/A'}</p>
                        </div>
                        <div>
                          <span className="text-sm font-medium text-gray-500">T√≠tulo:</span>
                          <p className="text-gray-900">{selectedProduct.title || 'N/A'}</p>
                        </div>
                        <div>
                          <span className="text-sm font-medium text-gray-500">Marca:</span>
                          <p className="text-gray-900">{selectedProduct.brand_name || 'N/A'}</p>
                        </div>
                        <div>
                          <span className="text-sm font-medium text-gray-500">Categoria:</span>
                          <p className="text-gray-900">{selectedProduct.category_name || 'N/A'}</p>
                        </div>
                      </div>
                    </div>
                    <div>
                      <h3 className="text-lg font-semibold text-gray-900 mb-3">Status</h3>
                      <div className="space-y-2">
                        <div className="flex items-center space-x-2">
                          <span className="text-sm font-medium text-gray-500">Ativo:</span>
                          <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                            selectedProduct.is_active 
                              ? 'bg-green-100 text-green-800' 
                              : 'bg-red-100 text-red-800'
                          }`}>
                            {selectedProduct.is_active ? 'Sim' : 'N√£o'}
                          </span>
                        </div>
                        <div className="flex items-center space-x-2">
                          <span className="text-sm font-medium text-gray-500">Vis√≠vel:</span>
                          <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                            selectedProduct.is_visible 
                              ? 'bg-blue-100 text-blue-800' 
                              : 'bg-gray-100 text-gray-800'
                          }`}>
                            {selectedProduct.is_visible ? 'Sim' : 'N√£o'}
                          </span>
                        </div>
                        <div>
                          <span className="text-sm font-medium text-gray-500">SKUs:</span>
                          <p className="text-gray-900">{(selectedProduct as any).stats?.skuCount || selectedProduct.sku_count || 0}</p>
                        </div>
                        <div>
                          <span className="text-sm font-medium text-gray-500">Imagens:</span>
                          <p className="text-gray-900">{(selectedProduct as any).stats?.imageCount || selectedProduct.image_count || 0}</p>
                        </div>
                        <div>
                          <span className="text-sm font-medium text-gray-500">An√°lises:</span>
                          <p className="text-gray-900">{(selectedProduct as any).stats?.analysisCount || 0}</p>
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Descri√ß√£o */}
                  {selectedProduct.description && (
                    <div>
                      <h3 className="text-lg font-semibold text-gray-900 mb-3">Descri√ß√£o</h3>
                      <p className="text-gray-700 leading-relaxed">{selectedProduct.description}</p>
                    </div>
                  )}

                  {/* SKUs */}
                  {productSKUs.length > 0 && (
                    <div>
                      <h3 className="text-lg font-semibold text-gray-900 mb-3">SKUs ({productSKUs.length})</h3>
                      <div className="space-y-2">
                        {productSKUs.map((sku, index) => (
                          <div key={index} className="p-3 bg-gray-50 rounded-lg">
                            <div className="flex items-center justify-between">
                              <div>
                                <p className="font-medium text-gray-900">{sku.name_complete}</p>
                                <p className="text-sm text-gray-500">ID: {sku.vtex_id}</p>
                              </div>
                              <button
                                onClick={() => copyToClipboard(sku.vtex_id.toString(), `sku-${sku.vtex_id}`)}
                                className="p-1 text-gray-400 hover:text-gray-600 transition-colors"
                              >
                                {copiedText === `sku-${sku.vtex_id}` ? (
                                  <Check className="h-4 w-4 text-green-600" />
                                ) : (
                                  <Copy className="h-4 w-4" />
                                )}
                              </button>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* Imagens */}
                  {productImages.length > 0 && (
                    <div>
                      <h3 className="text-lg font-semibold text-gray-900 mb-3">Imagens ({productImages.length})</h3>
                      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        {productImages.map((image, index) => (
                          <div key={index} className="relative">
                            <img
                              src={image.file_url}
                              alt={image.name}
                              className="w-full h-24 object-cover rounded-lg"
                            />
                            <div className="absolute top-2 right-2">
                              <button
                                onClick={() => copyToClipboard(image.file_url, `image-${image.id}`)}
                                className="p-1 bg-black/50 text-white rounded hover:bg-black/70 transition-colors"
                              >
                                {copiedText === `image-${image.id}` ? (
                                  <Check className="h-3 w-3" />
                                ) : (
                                  <Copy className="h-3 w-3" />
                                )}
                              </button>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* An√°lises de Imagem */}
                  {(selectedProduct as any).analysisLogs && (selectedProduct as any).analysisLogs.length > 0 && (
                    <div>
                      <h3 className="text-lg font-semibold text-gray-900 mb-3">An√°lises de Imagem ({(selectedProduct as any).analysisLogs.length})</h3>
                      <div className="space-y-3">
                        {(selectedProduct as any).analysisLogs.map((analysis: any, index: number) => (
                          <div key={index} className="p-4 bg-gray-50 rounded-lg border">
                            <div className="flex items-center justify-between mb-2">
                              <div className="flex items-center space-x-2">
                                <span className="text-sm font-medium text-gray-500">Agente:</span>
                                <span className="text-sm text-gray-900">{analysis.agent_name || 'N/A'}</span>
                              </div>
                              <div className="flex items-center space-x-2">
                                <span className="text-sm font-medium text-gray-500">Modelo:</span>
                                <span className="text-sm text-gray-900">{analysis.model_used || 'N/A'}</span>
                              </div>
                              <div className="flex items-center space-x-2">
                                <span className="text-sm font-medium text-gray-500">Tokens:</span>
                                <span className="text-sm text-gray-900">{analysis.tokens_used || 0}</span>
                              </div>
                            </div>
                            <div className="text-sm text-gray-600">
                              <span className="font-medium">Criado em:</span> {formatDate(analysis.created_at)}
                            </div>
                            {analysis.contextual_analysis && (
                              <div className="mt-2">
                                <button
                                  onClick={() => copyToClipboard(analysis.contextual_analysis, `analysis-${analysis.id}`)}
                                  className="text-sm text-blue-600 hover:text-blue-800 flex items-center"
                                >
                                  {copiedText === `analysis-${analysis.id}` ? (
                                    <>
                                      <Check className="h-3 w-3 mr-1" />
                                      Copiado!
                                    </>
                                  ) : (
                                    <>
                                      <Copy className="h-3 w-3 mr-1" />
                                      Copiar an√°lise
                                    </>
                                  )}
                                </button>
                              </div>
                            )}
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* Logs de Sincroniza√ß√£o Anymarket */}
                  {productSyncLogs.length > 0 && (
                    <div>
                      <h3 className="text-lg font-semibold text-gray-900 mb-3">Sincroniza√ß√µes Anymarket ({productSyncLogs.length})</h3>
                      <div className="space-y-3">
                        {productSyncLogs.map((log: any, index: number) => (
                          <div key={index} className="p-4 bg-gray-50 rounded-lg border">
                            <div className="flex items-center justify-between mb-2">
                              <div className="flex items-center space-x-2">
                                <span className="text-sm font-medium text-gray-500">ID_ANY:</span>
                                <span className="text-sm text-gray-900 font-mono">{log.anymarket_id}</span>
                              </div>
                              <div className="flex items-center space-x-2">
                                <span className="text-sm font-medium text-gray-500">Status:</span>
                                <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                                  log.success 
                                    ? 'bg-green-100 text-green-800' 
                                    : 'bg-red-100 text-red-800'
                                }`}>
                                  {log.success ? 'Sucesso' : 'Erro'}
                                </span>
                              </div>
                            </div>
                            <div className="text-sm text-gray-600 mb-2">
                              <span className="font-medium">Sincronizado em:</span> {formatDate(log.created_at)}
                            </div>
                            {log.title && (
                              <div className="text-sm text-gray-600 mb-2">
                                <span className="font-medium">T√≠tulo:</span> {log.title}
                              </div>
                            )}
                            {log.error_message && (
                              <div className="text-sm text-red-600 mb-2">
                                <span className="font-medium">Erro:</span> {log.error_message}
                              </div>
                            )}
                            {log.description && (
                              <div className="mt-2">
                                <button
                                  onClick={() => copyToClipboard(log.description, `sync-${log.id}`)}
                                  className="text-sm text-blue-600 hover:text-blue-800 flex items-center"
                                >
                                  {copiedText === `sync-${log.id}` ? (
                                    <>
                                      <Check className="h-3 w-3 mr-1" />
                                      Copiado!
                                    </>
                                  ) : (
                                    <>
                                      <Copy className="h-3 w-3 mr-1" />
                                      Copiar descri√ß√£o
                                    </>
                                  )}
                                </button>
                              </div>
                            )}
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              )}
            </div>

            {/* Footer do Modal */}
            <div className="flex items-center justify-end space-x-3 p-6 border-t border-gray-100">
              <button
                onClick={closeModal}
                className="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
              >
                Fechar
              </button>
              <button className="px-4 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-colors font-medium">
                <ExternalLink className="h-4 w-4 mr-2 inline" />
                Ver na VTEX
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Modal do Anymarket */}
      <AnymarketSyncModal
        isOpen={showAnymarketSyncModal}
        onClose={() => {
          setShowAnymarketSyncModal(false);
          setSelectedProductForAnymarket(null);
        }}
        product={selectedProductForAnymarket}
      />

      {/* Modal de An√°lise de Imagens */}
      {showImageAnalysisModal && selectedProductForAnalysis && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div className="p-6">
              <div className="flex items-center justify-between mb-6">
                <h2 className="text-2xl font-bold text-gray-900 flex items-center">
                  <Image className="w-6 h-6 mr-3 text-purple-600" />
                  An√°lise de Imagens - {selectedProductForAnalysis.name}
                </h2>
                <button
                  onClick={() => {
                    setShowImageAnalysisModal(false);
                    setCurrentAnalysisData(null);
                    setSelectedProductForAnalysis(null);
                    setAnalysisError(null);
                  }}
                  className="text-gray-400 hover:text-gray-600 transition-colors"
                >
                  <X className="h-6 w-6" />
                </button>
              </div>

              <div className="space-y-6 relative">
                {analyzingSingleImage && (
                  <div className="absolute inset-0 bg-white/80 backdrop-blur-sm z-10 flex items-center justify-center rounded-lg">
                    <div className="text-center">
                      <Loader2 className="w-8 h-8 animate-spin text-purple-600 mx-auto mb-2" />
                      <p className="text-sm text-gray-600">Regenerando an√°lise...</p>
                    </div>
                  </div>
                )}
                
                {currentAnalysisData ? (
                  <>
                    {/* Header com Status */}
                    <div className={`border rounded-lg p-6 ${analyzingSingleImage ? 'bg-gradient-to-r from-blue-50 to-purple-50 border-blue-200' : 'bg-gradient-to-r from-green-50 to-blue-50 border-green-200'}`}>
                      <div className="flex items-center justify-between">
                        <div className="flex items-center">
                          <div className={`w-12 h-12 rounded-full flex items-center justify-center mr-4 ${analyzingSingleImage ? 'bg-blue-100' : 'bg-green-100'}`}>
                            {analyzingSingleImage ? (
                              <Loader2 className="w-6 h-6 text-blue-600 animate-spin" />
                            ) : (
                              <Check className="w-6 h-6 text-green-600" />
                            )}
                          </div>
                          <div>
                            <h3 className={`text-lg font-semibold ${analyzingSingleImage ? 'text-blue-800' : 'text-green-800'}`}>
                              {analyzingSingleImage ? 'Regenerando An√°lise...' : 'An√°lise Conclu√≠da'}
                            </h3>
                            <p className={`text-sm ${analyzingSingleImage ? 'text-blue-600' : 'text-green-600'}`}>
                              {analyzingSingleImage ? 'Aguarde enquanto processamos as imagens...' : new Date(currentAnalysisData.analysis_log?.created_at || Date.now()).toLocaleString('pt-BR')}
                            </p>
                          </div>
                        </div>
                        <div className="text-right">
                          <div className="flex items-center space-x-4 text-sm text-gray-600">
                            <div className="flex items-center">
                              <Image className="w-4 h-4 mr-1" />
                              <span>{currentAnalysisData.analysis.image_count} imagens</span>
                            </div>
                            <div className="flex items-center">
                              <span className="w-2 h-2 bg-blue-500 rounded-full mr-1"></span>
                              <span className="capitalize">{currentAnalysisData.analysis.product_type}</span>
                            </div>
                            <div className="flex items-center">
                              <span className="w-2 h-2 bg-purple-500 rounded-full mr-1"></span>
                              <span className="capitalize">{currentAnalysisData.analysis.analysis_quality?.level || 'm√©dia-alta'}</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* An√°lise Principal */}
                    <div className="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                      <div className="flex items-center justify-between mb-4">
                        <h3 className="text-lg font-semibold text-gray-900 flex items-center">
                          <span className="w-8 h-8 bg-gradient-to-r from-purple-500 to-blue-500 text-white rounded-full flex items-center justify-center text-sm mr-3">ü§ñ</span>
                          An√°lise T√©cnica
                        </h3>
                        <div className="flex items-center space-x-2 text-xs text-gray-500">
                          <span className="bg-gray-100 px-2 py-1 rounded-full">
                            {currentAnalysisData.analysis.openai_analysis?.tokens_used || 0} tokens
                          </span>
                          <span className="bg-gray-100 px-2 py-1 rounded-full">
                            {currentAnalysisData.analysis.agent_configuration?.model || 'GPT-4o'}
                          </span>
                        </div>
                      </div>
                      <div className="bg-gray-50 rounded-lg p-4 border-l-4 border-purple-500">
                        <div className="prose prose-sm max-w-none">
                          <p className="text-gray-700 leading-relaxed text-sm">
                            {currentAnalysisData.analysis.contextual_analysis}
                          </p>
                        </div>
                      </div>
                    </div>

                    {/* Atributos Utilizados na An√°lise */}
                    {currentAnalysisData.product_attributes && currentAnalysisData.product_attributes.length > 0 && (
                      <div className="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                        <div className="flex items-center justify-between mb-4">
                          <h3 className="text-lg font-semibold text-gray-900 flex items-center">
                            <span className="w-8 h-8 bg-gradient-to-r from-green-500 to-teal-500 text-white rounded-full flex items-center justify-center text-sm mr-3">üìã</span>
                            Atributos Utilizados na An√°lise
                          </h3>
                          <span className="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">
                            {currentAnalysisData.product_attributes.length} atributos
                          </span>
                        </div>
                        <div className="mb-3">
                          <p className="text-sm text-gray-600">
                            Os seguintes atributos t√©cnicos foram utilizados para complementar a an√°lise visual:
                          </p>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          {currentAnalysisData.product_attributes.map((attr: any, index: number) => {
                            return (
                              <div key={index} className="bg-gray-50 rounded-lg p-4 border-l-4 border-green-500">
                                <div className="flex items-start justify-between">
                                  <div className="flex-1">
                                    <h4 className="font-medium text-gray-900 text-sm mb-1">
                                      {attr.attribute_name}
                                    </h4>
                                    <p className="text-gray-600 text-sm leading-relaxed">
                                      {attr.attribute_value}
                                    </p>
                                  </div>
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    )}

                    {/* Imagens Analisadas */}
                    {currentAnalysisData.images && currentAnalysisData.images.length > 0 && (
                      <div className="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                        <h3 className="font-semibold text-gray-900 mb-4 flex items-center">
                          <Image className="w-5 h-5 mr-2 text-blue-600" />
                          Imagens Analisadas
                          <span className="ml-2 bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">
                            {currentAnalysisData.images.length}
                          </span>
                        </h3>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                          {currentAnalysisData.images.map((image: any, index: number) => (
                            <div key={image.id} className="relative group">
                              <div className="aspect-square rounded-lg overflow-hidden border-2 border-gray-200 group-hover:border-blue-300 transition-colors">
                                <img
                                  src={image.url}
                                  alt={image.alt_text || 'Imagem do produto'}
                                  className="w-full h-full object-cover"
                                  onError={(e) => {
                                    e.currentTarget.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2YzZjRmNiIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSIjOWNhM2FmIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+SW1hZ2VtPC90ZXh0Pjwvc3ZnPg==';
                                  }}
                                />
                              </div>
                              {image.is_primary && (
                                <span className="absolute top-2 left-2 bg-blue-600 text-white text-xs px-2 py-1 rounded-full font-medium">
                                  Principal
                                </span>
                              )}
                              <div className="absolute bottom-2 right-2 bg-green-500 text-white text-xs px-2 py-1 rounded-full flex items-center">
                                <Check className="w-3 h-3 mr-1" />
                                Analisada
                              </div>
                              <div className="absolute top-2 right-2 bg-gray-800 text-white text-xs px-2 py-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity">
                                #{index + 1}
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    {/* Bot√µes de A√ß√£o */}
                    <div className="bg-gray-50 border border-gray-200 rounded-lg p-4">
                      <div className="flex items-center justify-between">
                        <div className="flex space-x-3">
                          <button
                            onClick={() => handleGenerateNewAnalysis(true)}
                            disabled={analyzingSingleImage}
                            className="px-6 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg hover:from-purple-700 hover:to-blue-700 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center font-medium shadow-sm"
                          >
                            {analyzingSingleImage ? (
                              <>
                                <Loader2 className="w-4 h-4 animate-spin mr-2" />
                                Regenerando...
                              </>
                            ) : (
                              <>
                                <RotateCcw className="w-4 h-4 mr-2" />
                                Regenerar An√°lise
                              </>
                            )}
                          </button>
                          
                          <button
                            onClick={() => copyToClipboard(currentAnalysisData.analysis.contextual_analysis, 'image-analysis')}
                            className="px-6 py-3 bg-white border-2 border-gray-300 text-gray-700 rounded-lg hover:border-blue-500 hover:text-blue-600 transition-all duration-200 flex items-center font-medium shadow-sm"
                          >
                            {copiedText === 'image-analysis' ? (
                              <>
                                <Check className="w-4 h-4 mr-2" />
                                Copiado!
                              </>
                            ) : (
                              <>
                                <Copy className="w-4 h-4 mr-2" />
                                Copiar An√°lise
                              </>
                            )}
                          </button>
                        </div>
                        
                        {/* Informa√ß√µes T√©cnicas (Discretas) */}
                        <div className="text-xs text-gray-500 flex items-center space-x-3">
                          <div className="flex items-center">
                            <span className="w-2 h-2 bg-green-500 rounded-full mr-1"></span>
                            <span>{currentAnalysisData.analysis_log?.duration_ms ? Math.round(currentAnalysisData.analysis_log.duration_ms / 1000) + 's' : 'N/A'}</span>
                          </div>
                          <div className="flex items-center">
                            <span className="w-2 h-2 bg-blue-500 rounded-full mr-1"></span>
                            <span>{currentAnalysisData.analysis.openai_analysis?.tokens_used || 0} tokens</span>
                          </div>
                          <div className="flex items-center">
                            <span className="w-2 h-2 bg-purple-500 rounded-full mr-1"></span>
                            <span>${currentAnalysisData.analysis_log?.openai_cost ? parseFloat(currentAnalysisData.analysis_log.openai_cost).toFixed(6) : '0.000000'}</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </>
                ) : (
                  <>
                    {/* Gerar Nova An√°lise */}
                    <div className="text-center">
                      <div className="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <Image className="w-8 h-8 text-purple-600" />
                      </div>
                      <h3 className="text-lg font-semibold text-gray-900 mb-2">
                        Gerar An√°lise de Imagens
                      </h3>
                      <p className="text-gray-600 mb-6">
                        Analise as imagens do produto usando IA para obter insights t√©cnicos e descri√ß√µes detalhadas.
                      </p>
                      <button
                        onClick={() => handleGenerateNewAnalysis(false)}
                        disabled={analyzingSingleImage}
                        className="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center mx-auto"
                      >
                        {analyzingSingleImage ? (
                          <>
                            <Loader2 className="w-5 h-5 animate-spin mr-2" />
                            Analisando...
                          </>
                        ) : (
                          <>
                            <Camera className="w-5 h-5 mr-2" />
                            Gerar An√°lise
                          </>
                        )}
                      </button>
                    </div>
                  </>
                )}
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Modal do Marketplace */}
      {showMarketplaceModal && selectedProductForTool && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div className="p-6">
              <div className="flex items-center justify-between mb-6">
                <h2 className="text-2xl font-bold text-gray-900 flex items-center">
                  <span className="w-8 h-8 bg-yellow-500 text-white rounded-lg flex items-center justify-center mr-3 text-lg font-bold">M</span>
                  Marketplace - {selectedProductForTool.name}
                </h2>
                <button
                  onClick={() => {
                    setShowMarketplaceModal(false);
                    setMarketplaceDescription(null);
                    setSelectedProductForTool(null);
                  }}
                  className="text-gray-400 hover:text-gray-600 transition-colors"
                >
                  <X className="h-6 w-6" />
                </button>
              </div>

              <div className="space-y-6">
                {marketplaceDescription ? (
                  <>


                    {/* T√≠tulo */}
                    <div>
                      <h3 className="text-lg font-semibold text-gray-900 mb-3">T√≠tulo Otimizado</h3>
                      <div className="bg-white border border-gray-200 rounded-lg p-4">
                        <div className="flex items-center justify-between mb-2">
                          <p className="text-gray-900 font-medium">{marketplaceDescription.optimizedTitle || selectedProductForTool?.name || 'N/A'}</p>
                          <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            ‚úì Otimizado
                          </span>
                        </div>
                        <p className="text-xs text-gray-500">
                          {(marketplaceDescription.optimizedTitle || selectedProductForTool?.name || '').length} caracteres
                        </p>
                      </div>
                    </div>

                    {/* Descri√ß√£o */}
                    <div>
                      <h3 className="text-lg font-semibold text-gray-900 mb-3">Descri√ß√£o Completa</h3>
                      <div className="bg-white border border-gray-200 rounded-lg p-4">
                        <div 
                          className="text-gray-700 leading-relaxed"
                          dangerouslySetInnerHTML={{ __html: marketplaceDescription.description || 'Nenhuma descri√ß√£o dispon√≠vel' }}
                        />
                      </div>
                    </div>



                    {/* Informa√ß√µes T√©cnicas */}
                    <div className="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                      <div className="flex items-center justify-between mb-4">
                        <h3 className="text-lg font-semibold text-gray-900 flex items-center">
                          <span className="w-8 h-8 bg-gradient-to-r from-yellow-500 to-orange-500 text-white rounded-full flex items-center justify-center text-sm mr-3">üí∞</span>
                          Informa√ß√µes T√©cnicas
                        </h3>
                        <div className="flex items-center space-x-2 text-xs text-gray-500">
                          <span className="bg-gray-100 px-2 py-1 rounded-full">
                            {marketplaceDescription.openai_tokens_used || 0} tokens
                          </span>
                          <span className="bg-gray-100 px-2 py-1 rounded-full">
                            {marketplaceDescription.openai_model || 'GPT-4o'}
                          </span>
                        </div>
                      </div>
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-sm">
                        <div>
                          <span className="font-medium text-gray-700">Modelo OpenAI:</span>
                          <p className="text-gray-600">{marketplaceDescription.openai_model || 'N/A'}</p>
                        </div>
                        <div>
                          <span className="font-medium text-gray-700">Tokens Utilizados:</span>
                          <p className="text-gray-600">{marketplaceDescription.openai_tokens_used || 0}</p>
                        </div>
                        <div>
                          <span className="font-medium text-gray-700">Custo:</span>
                          <p className="text-gray-600">${marketplaceDescription.openai_cost ? parseFloat(marketplaceDescription.openai_cost).toFixed(6) : '0.000000'}</p>
                        </div>
                        <div>
                          <span className="font-medium text-gray-700">Tempo de Resposta:</span>
                          <p className="text-gray-600">{marketplaceDescription.openai_response_time_ms || 0}ms</p>
                        </div>
                      </div>
                      {marketplaceDescription.openai_request_id && (
                        <div className="mt-3 pt-3 border-t border-gray-200">
                          <span className="font-medium text-gray-700">Request ID:</span>
                          <p className="text-gray-600 text-xs font-mono">{marketplaceDescription.openai_request_id}</p>
                        </div>
                      )}
                    </div>

                    {/* Bot√µes de A√ß√£o */}
                    <div className="bg-gray-50 border border-gray-200 rounded-lg p-4">
                      <div className="flex items-center justify-between">
                        <div className="flex space-x-3">
                          <button
                            onClick={() => handleGenerateMeliDescription(true)}
                            disabled={generatingMarketplace}
                            className="px-6 py-3 bg-gradient-to-r from-yellow-600 to-orange-600 text-white rounded-lg hover:from-yellow-700 hover:to-orange-700 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center font-medium shadow-sm"
                          >
                            {generatingMarketplace ? (
                              <>
                                <Loader2 className="w-4 h-4 animate-spin mr-2" />
                                Regenerando...
                              </>
                            ) : (
                              <>
                                <RotateCcw className="w-4 h-4 mr-2" />
                                Regenerar Descri√ß√£o
                              </>
                            )}
                          </button>
                          
                          <button
                            onClick={() => {
                              // Remover tags HTML para copiar apenas o texto
                              const textOnly = marketplaceDescription.description
                                .replace(/<br\s*\/?>/gi, '\n')
                                .replace(/<li>/gi, '‚Ä¢ ')
                                .replace(/<\/li>/gi, '\n')
                                .replace(/<b>/gi, '')
                                .replace(/<\/b>/gi, '')
                                .replace(/<[^>]*>/g, '')
                                .trim();
                              copyToClipboard(textOnly, 'marketplace-description');
                            }}
                            className="px-6 py-3 bg-white border-2 border-gray-300 text-gray-700 rounded-lg hover:border-blue-500 hover:text-blue-600 transition-all duration-200 flex items-center font-medium shadow-sm"
                          >
                            {copiedText === 'marketplace-description' ? (
                              <>
                                <Check className="w-4 h-4 mr-2" />
                                Copiado!
                              </>
                            ) : (
                              <>
                                <Copy className="w-4 h-4 mr-2" />
                                Copiar Descri√ß√£o
                              </>
                            )}
                          </button>
                        </div>
                        
                        {/* Informa√ß√µes T√©cnicas (Discretas) */}
                        <div className="text-xs text-gray-500 flex items-center space-x-3">
                          <div className="flex items-center">
                            <span className="w-2 h-2 bg-green-500 rounded-full mr-1"></span>
                            <span>{marketplaceDescription.openai_response_time_ms ? Math.round(marketplaceDescription.openai_response_time_ms / 1000) + 's' : 'N/A'}</span>
                          </div>
                          <div className="flex items-center">
                            <span className="w-2 h-2 bg-blue-500 rounded-full mr-1"></span>
                            <span>{marketplaceDescription.openai_tokens_used || 0} tokens</span>
                          </div>
                          <div className="flex items-center">
                            <span className="w-2 h-2 bg-purple-500 rounded-full mr-1"></span>
                            <span>${marketplaceDescription.openai_cost ? parseFloat(marketplaceDescription.openai_cost).toFixed(6) : '0.000000'}</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </>
                ) : (
                  <>
                    {/* Gerar Nova Descri√ß√£o */}
                    <div className="text-center">
                      <div className="w-16 h-16 bg-yellow-500 flex items-center justify-center mx-auto mb-4">
                        <svg className="w-8 h-8 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                      </div>
                      <h3 className="text-lg font-semibold text-gray-900 mb-2">
                        Gerar Descri√ß√£o para Marketplace
                      </h3>
                      <p className="text-gray-600 mb-6">
                        O sistema ir√° analisar o produto e gerar um t√≠tulo otimizado e uma descri√ß√£o completa para o marketplace, utilizando dados da VTEX, SKUs e an√°lise de imagens quando dispon√≠vel.
                      </p>
                      
                      <button
                        onClick={() => handleGenerateMeliDescription(false)}
                        disabled={generatingMarketplace}
                        className="px-6 py-3 bg-gradient-to-r from-yellow-600 to-orange-600 text-white rounded-lg hover:from-yellow-700 hover:to-orange-700 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center mx-auto font-medium shadow-sm"
                      >
                        {generatingMarketplace ? (
                          <>
                            <Loader2 className="w-5 h-5 animate-spin mr-2" />
                            Gerando...
                          </>
                        ) : (
                          <>
                            <span className="w-5 h-5 mr-2 bg-yellow-500 flex items-center justify-center">
                              <svg className="w-3 h-3 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                              </svg>
                            </span>
                            Gerar Descri√ß√£o
                          </>
                        )}
                      </button>
                    </div>
                  </>
                )}
              </div>

              <div className="flex justify-end pt-6 border-t border-gray-200 mt-6">
                <button
                  onClick={() => {
                    setShowMarketplaceModal(false);
                    setMarketplaceDescription(null);
                    setSelectedProductForTool(null);
                  }}
                  className="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors"
                >
                  Fechar
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Modal de Caracter√≠sticas */}
      {showCharacteristicsModal && selectedProductForTool && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div className="p-6">
              <div className="flex items-center justify-between mb-6">
                <h2 className="text-2xl font-bold text-gray-900 flex items-center">
                  <span className="w-8 h-8 bg-green-500 text-white rounded-lg flex items-center justify-center mr-3">
                    <List className="h-5 w-5" />
                  </span>
                  Caracter√≠sticas - {marketplaceDescription?.title || selectedProductForTool.name}
                </h2>
                <button
                  onClick={() => {
                    setShowCharacteristicsModal(false);
                    setSelectedProductForTool(null);
                    setExistingCharacteristics([]);
                    setLoadingCharacteristics(false);
                  }}
                  className="text-gray-400 hover:text-gray-600 transition-colors"
                >
                  <X className="h-6 w-6" />
                </button>
              </div>

              <div className="space-y-6">
                {/* Caracter√≠sticas Existentes */}
                {loadingCharacteristics ? (
                  <div className="bg-green-50 rounded-lg p-4">
                    <div className="flex items-center justify-center py-8">
                      <Loader2 className="w-6 h-6 animate-spin text-green-600 mr-3" />
                      <span className="text-green-600">Carregando caracter√≠sticas existentes...</span>
                    </div>
                  </div>
                ) : existingCharacteristics.length > 0 && (
                  <div className="bg-green-50 rounded-lg p-4">
                    <h3 className="text-lg font-semibold text-gray-900 mb-3">
                      Caracter√≠sticas Existentes ({existingCharacteristics.length})
                    </h3>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-2">
                      {existingCharacteristics.map((char, index) => (
                        <div key={index} className="bg-white rounded-md p-2 border border-green-200 hover:shadow-sm transition-shadow">
                          <div className="flex items-start justify-between">
                            <div className="flex-1 min-w-0">
                              <h4 className="font-medium text-gray-900 text-sm truncate" title={char.caracteristica}>
                                {char.caracteristica}
                              </h4>
                              <p className="text-xs text-gray-600 mt-1 line-clamp-2" title={char.resposta}>
                                {char.resposta}
                              </p>
                              {char.confianca && (
                                <div className="mt-1">
                                  <span className={`text-xs font-medium px-1.5 py-0.5 rounded ${
                                    char.confianca >= 0.8 ? 'bg-green-100 text-green-700' : 
                                    char.confianca >= 0.6 ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'
                                  }`}>
                                    {Math.round(char.confianca * 100)}%
                                  </span>
                                </div>
                              )}
                            </div>
                            <div className="ml-2 flex-shrink-0">
                              <div className="w-4 h-4 bg-green-500 rounded-full flex items-center justify-center">
                                <Check className="h-2.5 w-2.5 text-white" />
                              </div>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Bot√£o de Iniciar */}
                <div className="text-center">
                  <button
                    onClick={handleStartCharacteristicsGeneration}
                    disabled={generatingCharacteristics}
                    className="px-8 py-4 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-lg hover:from-green-700 hover:to-emerald-700 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center mx-auto font-medium shadow-sm text-lg"
                  >
                    {generatingCharacteristics ? (
                      <>
                        <Loader2 className="w-5 h-5 animate-spin mr-3" />
                        Gerando Caracter√≠sticas...
                      </>
                    ) : (
                      <>
                        <List className="w-5 h-5 mr-3" />
                        {existingCharacteristics.length > 0 ? 'Regenerar Caracter√≠sticas' : 'Iniciar Gera√ß√£o de Caracter√≠sticas'}
                      </>
                    )}
                  </button>
                </div>
              </div>

              <div className="flex justify-end pt-6 border-t border-gray-200 mt-6">
                <button
                  onClick={() => {
                    setShowCharacteristicsModal(false);
                    setSelectedProductForTool(null);
                    setExistingCharacteristics([]);
                    setLoadingCharacteristics(false);
                  }}
                  className="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors"
                >
                  Fechar
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Modal de Sele√ß√£o de An√°lise */}
      {showAnalysisSelectionModal && selectedProductForAnalysis && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
          <div className="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4">
            <div className="text-center">
              <div className="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <Image className="w-8 h-8 text-blue-600" />
              </div>
              <h3 className="text-lg font-semibold text-gray-900 mb-2">
                {existingAnalysis ? 'An√°lise Existente' : 'An√°lise de Imagens'}
              </h3>
              <p className="text-gray-600 mb-6">
                Produto: <span className="font-medium">{selectedProductForAnalysis.name}</span>
              </p>
              
              {existingAnalysis && (
                <div className="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                  <div className="flex items-center">
                    <div className="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mr-3">
                      <Check className="w-4 h-4 text-green-600" />
                    </div>
                    <div>
                      <p className="text-sm font-medium text-green-800">An√°lise j√° existe</p>
                      <p className="text-xs text-green-600">
                        Criada em: {new Date(existingAnalysis.created_at).toLocaleString('pt-BR')}
                      </p>
                    </div>
                  </div>
                </div>
              )}
              
              <div className="space-y-3">
                {existingAnalysis ? (
                  <>
                    <button
                      onClick={handleViewExistingAnalysis}
                      disabled={analyzingSingleImage}
                      className="w-full px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
                    >
                      {analyzingSingleImage ? (
                        <>
                          <Loader2 className="w-4 h-4 animate-spin mr-2" />
                          Carregando...
                        </>
                      ) : (
                        <>
                          <Eye className="w-4 h-4 mr-2" />
                          Ver An√°lise Existente
                        </>
                      )}
                    </button>
                    
                    <button
                      onClick={handleGenerateAnalysis}
                      disabled={analyzingSingleImage}
                      className="w-full px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
                    >
                      {analyzingSingleImage ? (
                        <>
                          <Loader2 className="w-4 h-4 animate-spin mr-2" />
                          Regenerando...
                        </>
                      ) : (
                        <>
                          <Image className="w-4 h-4 mr-2" />
                          Regenerar An√°lise
                        </>
                      )}
                    </button>
                  </>
                ) : (
                  <button
                    onClick={handleGenerateAnalysis}
                    disabled={analyzingSingleImage}
                    className="w-full px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
                  >
                    {analyzingSingleImage ? (
                      <>
                        <Loader2 className="w-4 h-4 animate-spin mr-2" />
                        Gerando An√°lise...
                      </>
                    ) : (
                      <>
                        <Image className="w-4 h-4 mr-2" />
                        Gerar Nova An√°lise
                      </>
                    )}
                  </button>
                )}
                
                <button
                  onClick={() => {
                    setShowAnalysisSelectionModal(false);
                    setSelectedProductForAnalysis(null);
                    setExistingAnalysis(null);
                  }}
                  className="w-full px-6 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
                >
                  Cancelar
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Loading de An√°lise - Apenas para an√°lise individual */}
      {analyzingSingleImage && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
          <div className="bg-white rounded-xl shadow-2xl p-8 flex flex-col items-center">
            <Loader2 className="w-8 h-8 text-blue-600 animate-spin mb-4" />
            <h3 className="text-lg font-semibold text-gray-900 mb-2">Analisando Imagens</h3>
            <p className="text-gray-600 text-center">
              O agente de IA est√° analisando as imagens do produto...
            </p>
          </div>
        </div>
      )}

      {/* Erro de An√°lise */}
      {analysisError && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
          <div className="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4">
            <div className="text-center">
              <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <X className="w-8 h-8 text-red-600" />
              </div>
              <h3 className="text-lg font-semibold text-gray-900 mb-2">Erro na An√°lise</h3>
              <p className="text-gray-600 mb-6">{analysisError}</p>
              <button
                onClick={() => setAnalysisError(null)}
                className="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
              >
                Fechar
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Modal de Crop de Imagens */}
      <CropImagesModal
        isOpen={showCropModal}
        onClose={() => {
          setShowCropModal(false);
          setCropModalData(null);
        }}
        product={cropModalData?.product || null}
        originalImages={cropModalData?.originalImages || []}
        onProcessingComplete={handleCropProcessingComplete}
      />

      {/* Modal de SKUs */}
      {showSkusModal && (
        <SimpleSkusModal
          isOpen={showSkusModal}
          onClose={() => {
            setShowSkusModal(false);
          }}
          productIds={products.filter(p => selectedProducts.includes(p.id)).map(p => p.id).filter(id => id != null && id != undefined)}
        />
      )}
      {/* Sistema de Notifica√ß√µes */}
      <div className="fixed top-4 right-4 z-[60] space-y-2">
        {notifications.map((notification) => (
          <div
            key={notification.id}
            className={`max-w-sm w-full bg-white rounded-lg shadow-lg border-l-4 p-4 transform transition-all duration-300 ease-in-out ${
              notification.type === 'success' ? 'border-green-500' :
              notification.type === 'error' ? 'border-red-500' :
              notification.type === 'warning' ? 'border-yellow-500' :
              'border-blue-500'
            }`}
          >
            <div className="flex items-start">
              <div className="flex-shrink-0">
                {notification.type === 'success' && <Check className="h-5 w-5 text-green-500" />}
                {notification.type === 'error' && <X className="h-5 w-5 text-red-500" />}
                {notification.type === 'warning' && <X className="h-5 w-5 text-yellow-500" />}
                {notification.type === 'info' && <X className="h-5 w-5 text-blue-500" />}
              </div>
              <div className="ml-3 flex-1">
                <h4 className={`text-sm font-medium ${
                  notification.type === 'success' ? 'text-green-800' :
                  notification.type === 'error' ? 'text-red-800' :
                  notification.type === 'warning' ? 'text-yellow-800' :
                  'text-blue-800'
                }`}>
                  {notification.title}
                </h4>
                <p className={`mt-1 text-sm ${
                  notification.type === 'success' ? 'text-green-700' :
                  notification.type === 'error' ? 'text-red-700' :
                  notification.type === 'warning' ? 'text-yellow-700' :
                  'text-blue-700'
                }`}>
                  {notification.message}
                </p>
              </div>
              <div className="ml-4 flex-shrink-0">
                <button
                  onClick={() => removeNotification(notification.id)}
                  className={`inline-flex rounded-md p-1.5 focus:outline-none focus:ring-2 focus:ring-offset-2 ${
                    notification.type === 'success' ? 'text-green-500 hover:bg-green-100 focus:ring-green-600' :
                    notification.type === 'error' ? 'text-red-500 hover:bg-red-100 focus:ring-red-600' :
                    notification.type === 'warning' ? 'text-yellow-500 hover:bg-yellow-100 focus:ring-yellow-600' :
                    'text-blue-500 hover:bg-blue-100 focus:ring-blue-600'
                  }`}
                >
                  <X className="h-4 w-4" />
                </button>
              </div>
            </div>
          </div>
        ))}
      </div>

      {/* Modal de Gera√ß√£o de T√≠tulo */}
      {showTitleModal && selectedProductForTool && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div className="p-6">
              <div className="flex items-center justify-between mb-6">
                <h2 className="text-2xl font-bold text-gray-900 flex items-center">
                  <span className="w-8 h-8 bg-purple-500 text-white rounded-lg flex items-center justify-center mr-3">
                    <Type className="h-5 w-5" />
                  </span>
                  Gera√ß√£o de T√≠tulo - {selectedProductForTool.name}
                </h2>
                <button
                  onClick={() => {
                    setShowTitleModal(false);
                    setSelectedProductForTool(null);
                    setGeneratedTitle(null);
                    setTitleError(null);
                    setGeneratingTitle(false);
                  }}
                  className="text-gray-400 hover:text-gray-600 transition-colors"
                >
                  <X className="h-6 w-6" />
                </button>
              </div>

              <div className="space-y-6">
                {/* Texto Explicativo */}
                {!generatedTitle && !titleError && (
                  <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div className="flex items-start">
                      <div className="flex-shrink-0">
                        <div className="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                          <Type className="w-4 h-4 text-blue-600" />
                        </div>
                      </div>
                      <div className="ml-3">
                        <h3 className="text-sm font-medium text-blue-800">
                          Gera√ß√£o de T√≠tulo Otimizado
                        </h3>
                        <div className="mt-2 text-sm text-blue-700">
                          <p className="mb-2">
                            <strong>O que ser√° feito:</strong> Criar um t√≠tulo otimizado para marketplace seguindo a estrutura: 
                            <span className="font-mono bg-blue-100 px-1 rounded">Categoria + Marca + G√™nero + Qualidade + Cor</span>
                          </p>
                          <p>
                            <strong>Dados utilizados:</strong> An√°lise de imagens, informa√ß√µes do produto VTEX, especifica√ß√µes t√©cnicas e dados dos SKUs.
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {/* Compara√ß√£o de T√≠tulos - quando h√° t√≠tulo gerado */}
                {generatedTitle && originalTitle && (
                  <div className="space-y-4">
                    {/* T√≠tulo Original */}
                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                      <h3 className="text-lg font-semibold text-blue-900 mb-3 flex items-center">
                        <Type className="w-5 h-5 mr-2" />
                        T√≠tulo Original
                      </h3>
                      <div className="bg-white rounded-lg p-3 border border-blue-200">
                        <p className="text-gray-900 text-sm leading-relaxed">{originalTitle}</p>
                        <div className="mt-2 text-xs text-gray-500">
                          {originalTitle?.length || 0} caracteres
                        </div>
                      </div>
                    </div>

                    {/* T√≠tulo Gerado */}
                    <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                      <h3 className="text-lg font-semibold text-green-900 mb-3 flex items-center">
                        <Type className="w-5 h-5 mr-2" />
                        T√≠tulo Otimizado
                      </h3>
                      <div className="bg-white rounded-lg p-3 border border-green-200">
                        <p className="text-gray-900 text-sm leading-relaxed">{generatedTitle}</p>
                        <div className="mt-2 text-xs text-gray-500">
                          {generatedTitle?.length || 0} caracteres
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {/* Bot√µes de A√ß√£o - quando h√° t√≠tulo gerado */}
                {generatedTitle && (
                  <div className="bg-gray-50 rounded-lg p-4">
                    <h3 className="text-lg font-semibold text-gray-900 mb-3">A√ß√µes</h3>
                    <div className="flex space-x-3">
                      <button
                        onClick={() => {
                          navigator.clipboard.writeText(generatedTitle);
                          addNotification(
                            'success',
                            'T√≠tulo Copiado!',
                            'T√≠tulo copiado para a √°rea de transfer√™ncia!',
                            3000
                          );
                        }}
                        className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center"
                      >
                        <Copy className="w-4 h-4 mr-2" />
                        Copiar T√≠tulo Otimizado
                      </button>
                      <button
                        onClick={() => handleStartTitleGeneration(true)}
                        disabled={generatingTitle}
                        className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center"
                      >
                        <RefreshCw className="w-4 h-4 mr-2" />
                        Regenerar T√≠tulo
                      </button>
                    </div>
                  </div>
                )}

                {/* Erro */}
                {titleError && (
                  <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                    <h3 className="text-lg font-semibold text-gray-900 mb-3 flex items-center">
                      <AlertCircle className="w-5 h-5 text-red-600 mr-2" />
                      Erro na Gera√ß√£o
                    </h3>
                    <p className="text-red-700">{titleError}</p>
                    <button
                      onClick={() => handleStartTitleGeneration(true)}
                      disabled={generatingTitle}
                      className="mt-3 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center"
                    >
                      <RefreshCw className="w-4 h-4 mr-2" />
                      Tentar Novamente
                    </button>
                  </div>
                )}

                {/* Bot√£o de Iniciar */}
                {!generatedTitle && !titleError && (
                  <div className="text-center">
                    <button
                      onClick={() => handleStartTitleGeneration(false)}
                      disabled={generatingTitle}
                      className="px-8 py-4 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg hover:from-purple-700 hover:to-indigo-700 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center mx-auto font-medium shadow-sm text-lg"
                    >
                      {generatingTitle ? (
                        <>
                          <Loader2 className="w-5 h-5 animate-spin mr-3" />
                          Gerando T√≠tulo...
                        </>
                      ) : (
                        <>
                          <Type className="w-5 h-5 mr-3" />
                          Gerar T√≠tulo Otimizado
                        </>
                      )}
                    </button>
                  </div>
                )}
              </div>

              <div className="flex justify-end pt-6 border-t border-gray-200 mt-6">
                <button
                  onClick={() => {
                    setShowTitleModal(false);
                    setSelectedProductForTool(null);
                    setGeneratedTitle(null);
                    setTitleError(null);
                    setGeneratingTitle(false);
                  }}
                  className="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors"
                >
                  Fechar
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </Layout>
  );
}



